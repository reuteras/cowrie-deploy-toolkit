{% extends "base.html" %}

{% block title %}Session {{ session.id | truncate_hash }} - Cowrie Honeypot{% endblock %}

{% block content %}
<div class="session-detail">
    <div class="page-header">
        <h1>Session Details</h1>
        <div class="header-actions">
            {% if has_tty %}
            <a href="{{ url_for('session_playback', session_id=session.id) }}" class="btn btn-primary">
                Play Session Recording
            </a>
            {% endif %}
            <a href="{{ url_for('sessions') }}" class="btn">Back to Sessions</a>
        </div>
    </div>

    <!-- Session Info -->
    <div class="detail-grid">
        <div class="detail-card">
            <h2>Connection Info</h2>
            <dl class="detail-list">
                <dt>Session ID</dt>
                <dd><code>{{ session.id }}</code></dd>

                <dt>Source IP</dt>
                <dd>
                    <a href="{{ url_for('sessions', ip=session.src_ip) }}">{{ session.src_ip }}</a>
                </dd>

                <dt>Location</dt>
                <dd>
                    {% if session.geo %}
                    {{ session.geo.city }}, {{ session.geo.country }} ({{ session.geo.country_code }})
                    {% else %}
                    Unknown
                    {% endif %}
                </dd>

                <dt>ASN</dt>
                <dd>
                    {% if session.geo and session.geo.asn %}
                    AS{{ session.geo.asn }}
                    {% if session.geo.asn_org %} - {{ session.geo.asn_org }}{% endif %}
                    {% else %}
                    Unknown
                    {% endif %}
                </dd>

                <dt>Client Version</dt>
                <dd><code>{{ session.client_version or 'Unknown' }}</code></dd>

                {% if threat_intel.greynoise %}
                <dt>GreyNoise</dt>
                <dd>
                    {% if threat_intel.greynoise.classification == 'malicious' %}
                    <span class="badge badge-danger">Malicious</span>
                    {% elif threat_intel.greynoise.classification == 'benign' %}
                    <span class="badge badge-success">Benign</span>
                    {% else %}
                    <span class="badge badge-warning">Unknown</span>
                    {% endif %}
                    <br>
                    <small style="color: var(--text-secondary);">{{ threat_intel.greynoise.message }}</small>
                </dd>
                {% endif %}

                {% if threat_intel.abuseipdb %}
                <dt>AbuseIPDB</dt>
                <dd>
                    {% if threat_intel.abuseipdb.abuse_confidence_score >= 75 %}
                    <span class="badge badge-danger">{{ threat_intel.abuseipdb.abuse_confidence_score }}% Confidence</span>
                    {% elif threat_intel.abuseipdb.abuse_confidence_score >= 25 %}
                    <span class="badge badge-warning">{{ threat_intel.abuseipdb.abuse_confidence_score }}% Confidence</span>
                    {% else %}
                    <span class="badge badge-info">{{ threat_intel.abuseipdb.abuse_confidence_score }}% Confidence</span>
                    {% endif %}
                    <br>
                    <small style="color: var(--text-secondary);">
                        Reports: {{ threat_intel.abuseipdb.total_reports }} |
                        {% if threat_intel.abuseipdb.isp %}ISP: {{ threat_intel.abuseipdb.isp }}{% endif %}
                        {% if threat_intel.abuseipdb.usage_type %} | Type: {{ threat_intel.abuseipdb.usage_type }}{% endif %}
                    </small>
                </dd>
                {% endif %}

                <dt>Start Time</dt>
                <dd>{{ session.start_time | format_timestamp }}</dd>

                <dt>End Time</dt>
                <dd>{{ session.end_time | format_timestamp }}</dd>

                <dt>Duration</dt>
                <dd>{{ session.duration | format_duration }}</dd>
            </dl>
        </div>

        <div class="detail-card">
            <h2>Authentication</h2>
            <dl class="detail-list">
                <dt>Login Status</dt>
                <dd>
                    {% if session.login_success %}
                    <span class="badge badge-success">Successful</span>
                    {% else %}
                    <span class="badge badge-danger">Failed</span>
                    {% endif %}
                </dd>

                <dt>Username</dt>
                <dd><code>{{ session.username or 'N/A' }}</code></dd>

                <dt>Password</dt>
                <dd><code>{{ session.password or 'N/A' }}</code></dd>
            </dl>

            {% if has_tty %}
            <div class="tty-info">
                <h3>TTY Recording Available</h3>
                <p>This session has a terminal recording.</p>
                <a href="{{ url_for('session_playback', session_id=session.id) }}" class="btn btn-primary">
                    Watch Recording
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Commands -->
    <div class="detail-card full-width">
        <h2>Commands Executed ({{ session.commands | length }})</h2>
        {% if session.commands %}
        <div class="terminal-output">
            {% for cmd in session.commands %}
            <div class="terminal-command">
                <div class="command-header">
                    <span class="command-time">{{ cmd.timestamp | format_timestamp }}</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">root@{{ session.src_ip.replace('.', '-') }}:~# </span>
                    <span class="command-input">{{ cmd.command or cmd.input }}</span>
                </div>
                {% if events %}
                    {% for event in events %}
                        {% if event.eventid == 'cowrie.command.success' and event.input == (cmd.command or cmd.input) %}
                            {% if event.output %}
                            <div class="command-output">
                                <pre>{{ event.output }}</pre>
                            </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
        <style>
            .terminal-output {
                background: #1e1e1e;
                color: #d4d4d4;
                padding: 20px;
                border-radius: 4px;
                font-family: 'Courier New', monospace;
                font-size: 14px;
                overflow-x: auto;
            }
            .terminal-command {
                margin-bottom: 15px;
            }
            .command-header {
                color: #6a9955;
                font-size: 12px;
                margin-bottom: 5px;
            }
            .terminal-line {
                display: flex;
                flex-wrap: wrap;
            }
            .prompt {
                color: #4ec9b0;
                font-weight: bold;
                white-space: nowrap;
            }
            .command-input {
                color: #dcdcaa;
                margin-left: 5px;
            }
            .command-output {
                margin-top: 5px;
                margin-left: 20px;
            }
            .command-output pre {
                margin: 0;
                color: #d4d4d4;
                white-space: pre-wrap;
                word-wrap: break-word;
            }
        </style>
        {% else %}
        <p class="no-data">No commands recorded for this session</p>
        {% endif %}
    </div>

    <!-- Downloads -->
    {% if session.downloads %}
    <div class="detail-card full-width">
        <h2>Downloaded Files ({{ session.downloads | length }})</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>URL</th>
                    <th>SHA256</th>
                </tr>
            </thead>
            <tbody>
                {% for dl in session.downloads %}
                <tr>
                    <td>{{ dl.timestamp | format_timestamp }}</td>
                    <td><code class="url-text">{{ dl.url }}</code></td>
                    <td>
                        <code>{{ dl.shasum | truncate_hash(24) }}</code>
                        <a href="https://www.virustotal.com/gui/file/{{ dl.shasum }}"
                           target="_blank"
                           class="external-link"
                           title="View on VirusTotal">VT</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- All Events Timeline -->
    <div class="detail-card full-width">
        <h2>Event Timeline ({{ events | length }} events)</h2>
        {% if events %}
        <div class="events-timeline">
            {% for event in events %}
            <div class="event-entry event-{{ event.eventid.split('.')[-1] }}">
                <div class="event-header">
                    <span class="event-time">{{ event.timestamp | format_timestamp }}</span>
                    <span class="event-type badge">{{ event.eventid }}</span>
                </div>
                <div class="event-details">
                    {% if event.eventid == 'cowrie.session.connect' %}
                        <p><strong>Session connected</strong> from {{ event.src_ip }}:{{ event.src_port }}</p>
                        {% if event.protocol %}<p>Protocol: <code>{{ event.protocol }}</code></p>{% endif %}

                    {% elif event.eventid == 'cowrie.client.version' %}
                        <p><strong>Client version:</strong> <code>{{ event.version }}</code></p>

                    {% elif event.eventid == 'cowrie.client.kex' %}
                        <p><strong>Key exchange:</strong></p>
                        <p>Algorithms: <code>{{ event.kexAlgs | join(', ') if event.kexAlgs else 'N/A' }}</code></p>

                    {% elif event.eventid == 'cowrie.login.success' %}
                        <p><strong>‚úì Login successful:</strong> <code>{{ event.username }}:{{ event.password }}</code></p>

                    {% elif event.eventid == 'cowrie.login.failed' %}
                        <p><strong>‚úó Login failed:</strong> <code>{{ event.username }}:{{ event.password }}</code></p>

                    {% elif event.eventid == 'cowrie.command.input' %}
                        <p><strong>Command:</strong> <code>{{ event.input }}</code></p>

                    {% elif event.eventid == 'cowrie.command.failed' %}
                        <p><strong>Command failed:</strong> <code>{{ event.input }}</code></p>

                    {% elif event.eventid == 'cowrie.session.file_download' %}
                        <p><strong>File download:</strong></p>
                        <p>URL: <code>{{ event.url }}</code></p>
                        <p>SHA256: <code>{{ event.shasum }}</code></p>
                        {% if event.outfile %}<p>Saved as: <code>{{ event.outfile }}</code></p>{% endif %}

                    {% elif event.eventid == 'cowrie.session.params' %}
                        <p><strong>Session parameters:</strong></p>
                        {% if event.arch %}<p>Architecture: <code>{{ event.arch }}</code></p>{% endif %}

                    {% elif event.eventid == 'cowrie.direct-tcpip.request' %}
                        <p><strong>Direct TCP/IP request:</strong></p>
                        <p>Destination: <code>{{ event.dst_ip }}:{{ event.dst_port }}</code></p>

                    {% elif event.eventid == 'cowrie.direct-tcpip.data' %}
                        <p><strong>Direct TCP/IP data:</strong> {{ event.data | length }} bytes</p>

                    {% elif event.eventid == 'cowrie.direct-tcpip.ja4' %}
                        <p><strong>JA4 fingerprint:</strong> <code>{{ event.ja4 }}</code></p>

                    {% elif event.eventid == 'cowrie.direct-tcpip.ja4h' %}
                        <p><strong>JA4H fingerprint:</strong> <code>{{ event.ja4h }}</code></p>

                    {% elif event.eventid == 'cowrie.log.closed' %}
                        <p><strong>TTY log closed:</strong></p>
                        {% if event.ttylog %}<p>File: <code>{{ event.ttylog }}</code></p>{% endif %}
                        {% if event.size %}<p>Size: {{ event.size }} bytes</p>{% endif %}

                    {% elif event.eventid == 'cowrie.session.closed' %}
                        <p><strong>Session closed</strong></p>
                        {% if event.duration %}<p>Duration: {{ event.duration | format_duration }}</p>{% endif %}

                    {% elif event.eventid == 'cowrie.greynoise.result' %}
                        <p><strong>üîç GreyNoise Intelligence:</strong></p>
                        <p>{{ event.message }}</p>
                        {% if event.classification %}<p>Classification: <span class="badge badge-{{ 'danger' if event.classification == 'malicious' else 'warning' }}">{{ event.classification }}</span></p>{% endif %}

                    {% elif event.eventid == 'cowrie.abuseipdb.reportedip' %}
                        <p><strong>üîç AbuseIPDB Intelligence:</strong></p>
                        <p>Abuse Confidence Score:
                            {% if event.abuseConfidenceScore >= 75 %}
                            <span class="badge badge-danger">{{ event.abuseConfidenceScore }}%</span>
                            {% elif event.abuseConfidenceScore >= 25 %}
                            <span class="badge badge-warning">{{ event.abuseConfidenceScore }}%</span>
                            {% else %}
                            <span class="badge badge-info">{{ event.abuseConfidenceScore }}%</span>
                            {% endif %}
                        </p>
                        {% if event.totalReports %}<p>Total Reports: {{ event.totalReports }}</p>{% endif %}
                        {% if event.isp %}<p>ISP: {{ event.isp }}</p>{% endif %}
                        {% if event.usageType %}<p>Usage Type: {{ event.usageType }}</p>{% endif %}
                        {% if event.isWhitelisted %}<p>Whitelisted: Yes</p>{% endif %}

                    {% else %}
                        <p><strong>Event data:</strong></p>
                        <pre style="font-size: 0.85em; overflow-x: auto;">{{ event | tojson(indent=2) }}</pre>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="no-data">No events found for this session</p>
        {% endif %}
    </div>
</div>
{% endblock %}
