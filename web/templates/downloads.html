{% extends "base.html" %}

{% block title %}Downloads - Cowrie Honeypot{% endblock %}

{% block content %}
<div class="downloads-page">
    <div class="page-header">
        <h1>Downloaded Files</h1>
        <div class="time-filter">
            {% if available_sources %}
            <label>Source:</label>
            <select id="source-filter" onchange="updateFilters()">
                <option value="" {% if not source_filter %}selected{% endif %}>All Honeypots</option>
                {% for source_name in available_sources %}
                <option value="{{ source_name }}" {% if source_filter == source_name %}selected{% endif %}>{{ source_name }}</option>
                {% endfor %}
            </select>
            {% endif %}
            <label>Time range:</label>
            <select id="hours-filter" onchange="updateFilters()">
                <option value="24" {% if hours == 24 %}selected{% endif %}>Last 24 hours</option>
                <option value="48" {% if hours == 48 %}selected{% endif %}>Last 48 hours</option>
                <option value="168" {% if hours == 168 %}selected{% endif %}>Last 7 days</option>
                <option value="720" {% if hours == 720 %}selected{% endif %}>Last 30 days</option>
            </select>
        </div>
    </div>

    <script>
    function updateFilters() {
        const source = document.getElementById('source-filter') ? document.getElementById('source-filter').value : '';
        const hours = document.getElementById('hours-filter').value;
        let url = '?hours=' + hours;
        if (source) {
            url += '&source=' + encodeURIComponent(source);
        }
        window.location.href = url;
    }
    </script>

    <div class="downloads-info">
        <p>{{ downloads | length }} unique files downloaded</p>
        <div class="alert alert-info" style="margin-top: 10px; padding: 10px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; color: #0c5460;">
            <strong>Download Protection:</strong> Files are available as password-protected ZIP archives. Password: <code>infected</code>
        </div>
    </div>

    <table class="data-table downloads-table sortable">
        <thead>
            <tr>
                <th>SHA256</th>
                <th>Type</th>
                <th>Size</th>
                <th>YARA</th>
                <th>VT Score</th>
                <th>VT Threat</th>
                <th>Downloads</th>
                <th>First Seen</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for dl in downloads %}
            <tr>
                <td>
                    {% if dl.exists %}
                    <a href="{{ url_for('download_zip', shasum=dl.shasum) }}"
                       title="Download as password-protected ZIP (password: infected)&#10;Full hash: {{ dl.shasum }}"
                       style="text-decoration: none; color: inherit;">
                        <code>{{ dl.shasum | truncate_hash(20) }}</code>
                    </a>
                    {% else %}
                    <code title="{{ dl.shasum }}">{{ dl.shasum | truncate_hash(20) }}</code>
                    <span class="badge badge-warning" title="File not found on disk">Missing</span>
                    {% endif %}
                </td>
                <td>
                    {% if dl.file_category %}
                        {% set category_colors = {
                            'executable': 'badge-danger',
                            'script': 'badge-warning',
                            'archive': 'badge-info',
                            'document': 'badge-primary',
                            'data': 'badge-secondary'
                        } %}
                        <span class="badge {{ category_colors.get(dl.file_category, 'badge-secondary') }}"
                              title="{{ dl.file_type or 'Unknown' }}">
                            {{ dl.file_category }}
                        </span>
                        {% if dl.file_type %}
                        <div style="font-size: 0.7em; color: #666; margin-top: 2px; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                             title="{{ dl.file_type }}">
                            {{ dl.file_type[:40] }}{% if dl.file_type | length > 40 %}...{% endif %}
                        </div>
                        {% endif %}
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if dl.size %}
                    {{ (dl.size / 1024) | round(1) }} KB
                    {% else %}
                    N/A
                    {% endif %}
                </td>
                <td>
                    {% if dl.yara_matches is defined and dl.yara_matches %}
                        <span class="badge badge-warning" title="{{ dl.yara_matches | join(', ') }}">
                            {{ dl.yara_matches | length }} match{% if dl.yara_matches | length > 1 %}es{% endif %}
                        </span>
                        <div class="yara-matches-tooltip" style="font-size: 0.75em; color: #666; margin-top: 2px;">
                            {{ dl.yara_matches[:3] | join(', ') }}{% if dl.yara_matches | length > 3 %}...{% endif %}
                        </div>
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if dl.vt_detections is defined %}
                        {% if dl.vt_detections > 0 %}
                        <span class="badge badge-danger">
                            {{ dl.vt_detections }}/{{ dl.vt_total }}
                        </span>
                        {% else %}
                        <span class="badge badge-success">0/{{ dl.vt_total }}</span>
                        {% endif %}
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </td>
                <td>
                    {% if dl.vt_threat_label %}
                    <span class="badge badge-warning" style="background: #fff3cd; color: #856404;">
                        {{ dl.vt_threat_label }}
                    </span>
                    {% else %}
                    <span class="text-muted">—</span>
                    {% endif %}
                </td>
                <td>{{ dl.count }}x</td>
                <td>{{ dl.timestamp | format_timestamp }}</td>
                <td class="actions">
                    {% if dl.is_previewable and dl.exists %}
                    <a href="{{ url_for('download_preview', shasum=dl.shasum) }}"
                       class="btn btn-sm btn-preview"
                       title="Preview file content">Preview</a>
                    {% endif %}
                    <a href="https://www.virustotal.com/gui/file/{{ dl.shasum }}"
                       target="_blank"
                       class="btn btn-sm"
                       title="View on VirusTotal">VT</a>
                    <a href="{{ url_for('session_detail', session_id=dl.session_id) }}"
                       class="btn btn-sm"
                       title="View session">Session</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="no-data">No downloads recorded</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
