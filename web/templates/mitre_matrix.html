{% block title %}MITRE ATT&CK Matrix - Cowrie Honeypot{% endblock %}

{% block content %}
<style>
.mitre-matrix {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.matrix-container {
    display: grid;
    grid-template-columns: 200px 1fr;
    gap: 20px;
    margin-top: 20px;
}

.tactic-column {
    display: flex;
    flex-direction: column;
}

.tactic-header {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    text-align: center;
    font-weight: 600;
    border: 2px solid var(--border-color);
}

.technique-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 8px;
}

.technique-cell {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 8px;
    text-align: center;
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.technique-cell:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.technique-cell.active {
    background: #e74c3c;
    color: white;
    border-color: #c0392b;
}

.technique-cell.active.medium {
    background: #f39c12;
    border-color: #e67e22;
}

.technique-cell.active.low {
    background: #27ae60;
    border-color: #229954;
}

.technique-id {
    font-weight: 600;
    font-size: 0.8em;
    margin-bottom: 2px;
}

.technique-name {
    font-size: 0.75em;
    line-height: 1.2;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.cluster-count {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--accent-color);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7em;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
}

.matrix-legend {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
}

.matrix-controls {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
}

.control-group label {
    font-weight: 500;
}

select, input[type="range"] {
    padding: 6px 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.matrix-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    background: var(--bg-secondary);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
}

.stat-value {
    font-size: 1.8em;
    font-weight: 700;
    color: var(--accent-color);
    display: block;
}

.stat-label {
    font-size: 0.9em;
    color: var(--text-secondary);
    margin-top: 5px;
}

.technique-tooltip {
    position: absolute;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    padding: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
    max-width: 300px;
    display: none;
    pointer-events: none;
}

.tooltip-title {
    font-weight: 600;
    margin-bottom: 5px;
}

.tooltip-description {
    font-size: 0.85em;
    line-height: 1.4;
    margin-bottom: 8px;
}

.tooltip-clusters {
    font-size: 0.8em;
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .matrix-container {
        grid-template-columns: 1fr;
    }

    .tactic-column {
        order: 2;
    }

    .technique-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }

    .technique-cell {
        min-height: 50px;
        padding: 6px;
    }

    .technique-name {
        font-size: 0.7em;
    }
}
</style>

<div class="page">
    <div class="page-header">
        <h1>MITRE ATT&CK Matrix</h1>
        <div class="page-description">
            <p>Interactive visualization of MITRE ATT&CK techniques detected in honeypot clusters.</p>
            <p>Click on techniques to view cluster details and attack patterns.</p>
        </div>
    </div>

    <!-- Statistics -->
    <div class="matrix-stats">
        <div class="stat-card">
            <span class="stat-value" id="total-techniques">0</span>
            <div class="stat-label">Techniques Detected</div>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="active-clusters">0</span>
            <div class="stat-label">Active Clusters</div>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="covered-tactics">0</span>
            <div class="stat-label">Tactics Covered</div>
        </div>
        <div class="stat-card">
            <span class="stat-value" id="high-confidence">0</span>
            <div class="stat-label">High Confidence</div>
        </div>
    </div>

    <!-- Controls -->
    <div class="matrix-controls">
        <div class="control-group">
            <label>Confidence Threshold:</label>
            <input type="range" id="confidence-slider" min="0" max="100" value="50" step="10">
            <span id="confidence-value">50</span>
        </div>

        <div class="control-group">
            <label>Tactic Filter:</label>
            <select id="tactic-filter">
                <option value="">All Tactics</option>
            </select>
        </div>

        <div class="control-group">
            <label>Time Range:</label>
            <select id="time-filter">
                <option value="7">Last 7 days</option>
                <option value="30">Last 30 days</option>
                <option value="90">Last 90 days</option>
                <option value="all">All time</option>
            </select>
        </div>
    </div>

    <!-- Legend -->
    <div class="matrix-legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #e74c3c;"></div>
            <span>High Confidence (80-100%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f39c12;"></div>
            <span>Medium Confidence (50-79%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #27ae60;"></div>
            <span>Low Confidence (0-49%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: var(--bg-primary); border: 1px solid var(--border-color);"></div>
            <span>Not Detected</span>
        </div>
    </div>

    <!-- Matrix Container -->
    <div class="matrix-container">
        <div class="tactic-column" id="tactic-column">
            <!-- Tactic headers will be populated by JavaScript -->
        </div>
        <div class="technique-grid" id="technique-grid">
            <!-- Technique cells will be populated by JavaScript -->
        </div>
    </div>

    <!-- Tooltip -->
    <div class="technique-tooltip" id="technique-tooltip"></div>
</div>

<script>
// MITRE ATT&CK tactics in order
const TACTICS = [
    {id: 'TA0001', name: 'Initial Access', shortName: 'IA'},
    {id: 'TA0002', name: 'Execution', shortName: 'EX'},
    {id: 'TA0003', name: 'Persistence', shortName: 'PE'},
    {id: 'TA0004', name: 'Privilege Escalation', shortName: 'PE'},
    {id: 'TA0005', name: 'Defense Evasion', shortName: 'DE'},
    {id: 'TA0006', name: 'Credential Access', shortName: 'CA'},
    {id: 'TA0007', name: 'Discovery', shortName: 'DI'},
    {id: 'TA0008', name: 'Lateral Movement', shortName: 'LM'},
    {id: 'TA0009', name: 'Collection', shortName: 'CO'},
    {id: 'TA0010', name: 'Exfiltration', shortName: 'EX'},
    {id: 'TA0011', name: 'Command and Control', shortName: 'CC'},
    {id: 'TA0040', name: 'Impact', shortName: 'IM'}
];

let matrixData = {};
let currentFilters = {
    confidence: 50,
    tactic: '',
    days: 7
};

document.addEventListener('DOMContentLoaded', function() {
    initializeMatrix();
    loadMatrixData();
    setupEventListeners();
});

function initializeMatrix() {
    const tacticColumn = document.getElementById('tactic-column');

    // Create tactic headers
    TACTICS.forEach(tactic => {
        const header = document.createElement('div');
        header.className = 'tactic-header';
        header.textContent = `${tactic.shortName}: ${tactic.name}`;
        header.dataset.tacticId = tactic.id;
        tacticColumn.appendChild(header);
    });

    // Initialize empty technique grid
    const techniqueGrid = document.getElementById('technique-grid');
    const totalCells = TACTICS.length * 15; // Assume ~15 techniques per tactic

    for (let i = 0; i < totalCells; i++) {
        const cell = document.createElement('div');
        cell.className = 'technique-cell';
        cell.innerHTML = '<div class="technique-id">-</div><div class="technique-name">-</div>';
        techniqueGrid.appendChild(cell);
    }
}

function loadMatrixData() {
    const url = `${basePath}/api/clusters/ttp?min_score=0`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.clusters) {
                processMatrixData(data.clusters);
                updateMatrixDisplay();
                updateStatistics(data.clusters);
            }
        })
        .catch(error => {
            console.error('Failed to load matrix data:', error);
        });
}

function processMatrixData(clusters) {
    matrixData = {};

    clusters.forEach(cluster => {
        if (cluster.cluster_type === 'ttp' && cluster.dominant_technique) {
            const techniqueId = cluster.dominant_technique;

            if (!matrixData[techniqueId]) {
                matrixData[techniqueId] = {
                    technique_id: techniqueId,
                    name: cluster.technique_name || techniqueId,
                    clusters: [],
                    max_score: 0,
                    tactic_id: cluster.dominant_tactic
                };
            }

            matrixData[techniqueId].clusters.push(cluster);
            matrixData[techniqueId].max_score = Math.max(matrixData[techniqueId].max_score, cluster.score);
        }
    });
}

function updateMatrixDisplay() {
    const techniqueGrid = document.getElementById('technique-grid');
    const cells = techniqueGrid.querySelectorAll('.technique-cell');

    // Clear existing content
    cells.forEach(cell => {
        cell.innerHTML = '<div class="technique-id">-</div><div class="technique-name">-</div>';
        cell.className = 'technique-cell';
        cell.onclick = null;
    });

    let cellIndex = 0;

    TACTICS.forEach(tactic => {
        const tacticTechniques = Object.values(matrixData).filter(tech =>
            tech.tactic_id === tactic.id
        );

        tacticTechniques.forEach(technique => {
            if (cellIndex < cells.length) {
                const cell = cells[cellIndex];
                const score = technique.max_score;
                const confidence = Math.min(score, 100);

                // Update cell content
                cell.innerHTML = `
                    <div class="technique-id">${technique.technique_id}</div>
                    <div class="technique-name">${technique.name}</div>
                    ${technique.clusters.length > 0 ? `<div class="cluster-count">${technique.clusters.length}</div>` : ''}
                `;

                // Apply confidence styling
                if (confidence >= currentFilters.confidence) {
                    cell.classList.add('active');
                    if (confidence >= 80) {
                        cell.classList.add('high');
                    } else if (confidence >= 50) {
                        cell.classList.add('medium');
                    } else {
                        cell.classList.add('low');
                    }

                    // Add click handler
                    cell.onclick = () => showTechniqueDetails(technique);
                }

                cellIndex++;
            }
        });

        // Fill remaining cells in this tactic column with empty cells
        const remainingCells = 15 - tacticTechniques.length;
        for (let i = 0; i < remainingCells && cellIndex < cells.length; i++) {
            cells[cellIndex].innerHTML = '<div class="technique-id">-</div><div class="technique-name">-</div>';
            cellIndex++;
        }
    });
}

function updateStatistics(clusters) {
    const techniques = Object.keys(matrixData);
    const tactics = new Set(Object.values(matrixData).map(t => t.tactic_id));
    const highConfidence = Object.values(matrixData).filter(t => t.max_score >= 80).length;

    document.getElementById('total-techniques').textContent = techniques.length;
    document.getElementById('active-clusters').textContent = clusters.length;
    document.getElementById('covered-tactics').textContent = tactics.size;
    document.getElementById('high-confidence').textContent = highConfidence;
}

function setupEventListeners() {
    // Confidence slider
    const confidenceSlider = document.getElementById('confidence-slider');
    const confidenceValue = document.getElementById('confidence-value');

    confidenceSlider.addEventListener('input', function() {
        currentFilters.confidence = parseInt(this.value);
        confidenceValue.textContent = this.value;
        updateMatrixDisplay();
    });

    // Tactic filter
    const tacticFilter = document.getElementById('tactic-filter');
    TACTICS.forEach(tactic => {
        const option = document.createElement('option');
        option.value = tactic.id;
        option.textContent = tactic.name;
        tacticFilter.appendChild(option);
    });

    tacticFilter.addEventListener('change', function() {
        currentFilters.tactic = this.value;
        updateMatrixDisplay();
    });

    // Time filter
    document.getElementById('time-filter').addEventListener('change', function() {
        currentFilters.days = this.value === 'all' ? 365 : parseInt(this.value);
        loadMatrixData(); // Reload data with new time filter
    });
}

function showTechniqueDetails(technique) {
    const tooltip = document.getElementById('technique-tooltip');

    tooltip.innerHTML = `
        <div class="tooltip-title">${technique.technique_id}: ${technique.name}</div>
        <div class="tooltip-description">Maximum confidence: ${technique.max_score}%</div>
        <div class="tooltip-clusters">${technique.clusters.length} cluster(s) detected</div>
    `;

    // Position tooltip (simplified)
    tooltip.style.display = 'block';
    tooltip.style.left = '50%';
    tooltip.style.top = '50%';

    // Hide after 3 seconds
    setTimeout(() => {
        tooltip.style.display = 'none';
    }, 3000);
}

// Hide tooltip on click outside
document.addEventListener('click', function(e) {
    const tooltip = document.getElementById('technique-tooltip');
    if (!e.target.closest('.technique-cell') && tooltip.style.display === 'block') {
        tooltip.style.display = 'none';
    }
});
</script>

{% endblock %}