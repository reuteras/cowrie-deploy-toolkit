{% extends "base.html" %}

{% block title %}Cluster {{ cluster_id }} - Cowrie Honeypot{% endblock %}

{% block content %}
<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
.loading-state { text-align: center; padding: 60px 20px; color: #666; }
.cluster-header-card { background: var(--bg-secondary); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
.cluster-type { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; text-transform: uppercase; }
.cluster-type.command { background: #3498db; color: white; }
.cluster-type.hassh { background: #9b59b6; color: white; }
.cluster-type.payload { background: #e74c3c; color: white; }
.cluster-score { font-size: 2em; font-weight: 700; }
.cluster-score.high { color: #e74c3c; }
.cluster-score.medium { color: #f39c12; }
.cluster-score.low { color: #27ae60; }
.stats-row { display: flex; gap: 30px; margin: 20px 0; flex-wrap: wrap; }
.stat-item { text-align: center; min-width: 100px; }
.stat-value { font-size: 1.8em; font-weight: 600; color: var(--accent-color); }
.stat-label { font-size: 0.85em; color: var(--text-secondary); }
.section { margin-top: 30px; }
.section-title { font-size: 1.2em; font-weight: 600; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
.member-card { background: var(--bg-secondary); border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.member-ip { font-family: monospace; font-size: 1.1em; font-weight: 600; color: var(--accent-color); }
.member-stats { display: flex; gap: 20px; }
.member-stat { text-align: center; }
.member-stat-value { font-weight: 600; }
.member-stat-label { font-size: 0.8em; color: var(--text-secondary); }
.intel-card { background: var(--bg-tertiary); border-radius: 6px; padding: 12px; margin-top: 10px; }
.intel-source { font-weight: 600; margin-bottom: 8px; }
.intel-tag { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 3px; font-size: 0.8em; background: var(--bg-secondary); }
.intel-tag.threat { background: #e74c3c; color: white; }
.intel-tag.port { background: #3498db; color: white; }
.fingerprint-box { background: var(--bg-tertiary); padding: 15px; border-radius: 6px; font-family: monospace; word-break: break-all; }
.command-list { background: var(--bg-tertiary); padding: 15px; border-radius: 6px; font-family: monospace; font-size: 0.9em; }
.command-item { padding: 5px 0; border-bottom: 1px solid var(--border-color); }
.command-item:last-child { border-bottom: none; }
.enrichment-section { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #0f3460; border-radius: 8px; padding: 20px; margin-top: 20px; }
.enrichment-title { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
.enrichment-title h3 { margin: 0; color: #e94560; }
.enrichment-badge { background: #e94560; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; }
.enrichment-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
.enrichment-card { background: rgba(255,255,255,0.05); border-radius: 6px; padding: 15px; }
.enrichment-card-title { font-size: 0.85em; color: #888; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
.enrichment-item { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
.enrichment-item:last-child { border-bottom: none; }
.enrichment-item-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 0.8em; }
.enrichment-item-icon.actor { background: #e74c3c; }
.enrichment-item-icon.campaign { background: #f39c12; }
.enrichment-item-icon.malware { background: #9b59b6; }
.enrichment-item-name { font-weight: 500; }
.enrichment-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
.enrichment-tag { background: rgba(233, 69, 96, 0.2); color: #e94560; padding: 4px 10px; border-radius: 4px; font-size: 0.8em; }
.enrich-btn { background: #e94560; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em; display: inline-flex; align-items: center; gap: 6px; }
.enrich-btn:hover { background: #c73e54; }
.enrich-btn:disabled { background: #555; cursor: not-allowed; }
.interest-reasons { margin-top: 10px; }
.interest-reason { display: inline-block; background: rgba(52, 152, 219, 0.2); color: #3498db; padding: 3px 8px; border-radius: 4px; font-size: 0.8em; margin: 2px; }
</style>

<div class="page">
    <div class="page-header">
        <h1>Cluster Details</h1>
        <div class="header-actions">
            <a href="{{ url_for('clusters', hours=hours) }}" class="btn">Back to Clusters</a>
            <a href="{{ url_for('index') }}" class="btn">Dashboard</a>
        </div>
    </div>

    <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p style="font-size: 16px; font-weight: 500;">Loading cluster details...</p>
    </div>

    <div id="error-state" class="loading-state" style="display:none; color: #d32f2f;">
        <p style="font-size: 16px; font-weight: 500;">Failed to load cluster</p>
        <p style="font-size: 12px;" id="error-message"></p>
        <a href="{{ url_for('clusters') }}" class="btn" style="margin-top: 15px;">Back to Clusters</a>
    </div>

    <div id="content" style="display: none;">
        <div class="cluster-header-card">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
                <div>
                    <span id="cluster-type" class="cluster-type">-</span>
                    <h2 id="cluster-name" style="margin: 10px 0 5px 0;">-</h2>
                    <p id="cluster-description" style="color: var(--text-secondary); margin: 0;">-</p>
                </div>
                <div style="text-align: right;">
                    <div class="cluster-score" id="cluster-score">-</div>
                    <div style="color: var(--text-secondary);">Threat Score</div>
                </div>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="stat-size">-</div>
                    <div class="stat-label">Unique IPs</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-sessions">-</div>
                    <div class="stat-label">Total Sessions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-first">-</div>
                    <div class="stat-label">First Seen</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="stat-last">-</div>
                    <div class="stat-label">Last Seen</div>
                </div>
            </div>
        </div>

        <div class="section" id="fingerprint-section">
            <div class="section-title">Fingerprint</div>
            <div class="fingerprint-box" id="fingerprint-value">-</div>
        </div>

        <div class="section" id="commands-section" style="display: none;">
            <div class="section-title">Sample Commands</div>
            <div class="command-list" id="commands-list"></div>
            <div id="interest-reasons" class="interest-reasons" style="display: none;"></div>
        </div>

        <div class="section" id="shared-payloads-section" style="display: none;">
            <div class="section-title">Shared Payloads</div>
            <div class="command-list" id="shared-payloads-list"></div>
        </div>

        <div class="section" id="hassh-section" style="display: none;">
            <div class="section-title">HASSH Fingerprints</div>
            <div class="command-list" id="hassh-list"></div>
        </div>

        <div class="section" id="enrichment-section" class="enrichment-section" style="display: none;">
            <div class="enrichment-title">
                <h3>OpenCTI Threat Intelligence</h3>
                <span class="enrichment-badge" id="enrichment-status">Not Enriched</span>
            </div>
            <div id="enrichment-content">
                <p style="color: var(--text-secondary);">
                    Click the button below to enrich this cluster with threat intelligence from OpenCTI.
                </p>
                <button class="enrich-btn" id="enrich-btn" onclick="enrichCluster()">
                    <span>üîç</span> Enrich with OpenCTI
                </button>
            </div>
            <div id="enrichment-data" style="display: none;">
                <div class="enrichment-grid">
                    <div class="enrichment-card" id="threat-actors-card" style="display: none;">
                        <div class="enrichment-card-title">Threat Actors</div>
                        <div id="threat-actors-list"></div>
                    </div>
                    <div class="enrichment-card" id="campaigns-card" style="display: none;">
                        <div class="enrichment-card-title">Campaigns</div>
                        <div id="campaigns-list"></div>
                    </div>
                    <div class="enrichment-card" id="malware-card" style="display: none;">
                        <div class="enrichment-card-title">Malware Families</div>
                        <div id="malware-list"></div>
                    </div>
                </div>
                <div id="enrichment-tags" class="enrichment-tags" style="display: none;"></div>
            </div>
        </div>

        <div class="section" id="payload-section" style="display: none;">
            <div class="section-title">Payload Information</div>
            <div style="background: var(--bg-secondary); border-radius: 8px; padding: 15px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">SHA256</div>
                        <div id="payload-sha256" style="font-family: monospace; word-break: break-all; margin-top: 5px;">-</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">Threat Label</div>
                        <div id="payload-threat" style="margin-top: 5px;">-</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); font-size: 0.85em;">VirusTotal Detections</div>
                        <div id="payload-vt" style="margin-top: 5px;">-</div>
                    </div>
                </div>
                <div id="payload-urls" style="margin-top: 15px; display: none;">
                    <div style="color: var(--text-secondary); font-size: 0.85em; margin-bottom: 8px;">Download URLs</div>
                    <div id="payload-urls-list" class="command-list"></div>
                </div>
                <div style="margin-top: 15px;">
                    <a id="vt-link" href="#" target="_blank" class="btn btn-sm" style="display: none;">View on VirusTotal</a>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Member IPs (<span id="member-count">0</span>)</div>
            <div id="members-list"></div>
        </div>
    </div>
</div>

<script>
const clusterId = "{{ cluster_id }}";

function getScoreClass(score) {
    if (score >= 70) return 'high';
    if (score >= 40) return 'medium';
    return 'low';
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDateTime(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function loadThreatIntel(ip) {
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10s client timeout

        const response = await fetch(basePath + '/api/ip-intel/' + ip, {
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) return null;
        const data = await response.json();
        // Return null if no useful data
        if (!data.summary || Object.keys(data.summary).length === 0) return null;
        return data;
    } catch (e) {
        // Don't log abort/timeout errors - expected for slow external APIs
        if (e.name !== 'AbortError') {
            console.log('Failed to load threat intel for', ip);
        }
        return null;
    }
}

function renderThreatIntel(intel, container) {
    if (!intel || !intel.summary) return;

    let html = '<div class="intel-card">';

    if (intel.summary.is_known_threat) {
        html += '<span class="intel-tag threat">Known Threat</span> ';
    }

    if (intel.summary.open_ports && intel.summary.open_ports.length > 0) {
        html += '<div style="margin-top: 8px;"><strong>Open Ports:</strong> ';
        html += intel.summary.open_ports.slice(0, 10).map(p => `<span class="intel-tag port">${p}</span>`).join(' ');
        if (intel.summary.open_ports.length > 10) html += ` +${intel.summary.open_ports.length - 10} more`;
        html += '</div>';
    }

    if (intel.summary.tags && intel.summary.tags.length > 0) {
        html += '<div style="margin-top: 8px;"><strong>Tags:</strong> ';
        html += intel.summary.tags.map(t => `<span class="intel-tag">${escapeHtml(t)}</span>`).join(' ');
        html += '</div>';
    }

    if (intel.summary.vulnerabilities && intel.summary.vulnerabilities.length > 0) {
        html += '<div style="margin-top: 8px;"><strong>Vulnerabilities:</strong> ';
        html += intel.summary.vulnerabilities.slice(0, 5).map(v => `<span class="intel-tag threat">${escapeHtml(v)}</span>`).join(' ');
        if (intel.summary.vulnerabilities.length > 5) html += ` +${intel.summary.vulnerabilities.length - 5} more`;
        html += '</div>';
    }

    html += '</div>';
    container.innerHTML += html;
}

async function loadData() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('error-state').style.display = 'none';
    document.getElementById('content').style.display = 'none';

    try {
        const response = await fetch(basePath + '/api/cluster/' + clusterId);
        if (!response.ok) {
            throw new Error(response.status === 404 ? 'Cluster not found' : 'Server error ' + response.status);
        }

        const cluster = await response.json();

        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // Update header
        const typeEl = document.getElementById('cluster-type');
        typeEl.textContent = cluster.cluster_type;
        typeEl.className = 'cluster-type ' + cluster.cluster_type;

        document.getElementById('cluster-name').textContent = cluster.name || cluster.cluster_id;
        document.getElementById('cluster-description').textContent = cluster.description || '';

        const scoreEl = document.getElementById('cluster-score');
        scoreEl.textContent = cluster.score;
        scoreEl.className = 'cluster-score ' + getScoreClass(cluster.score);

        // Stats
        document.getElementById('stat-size').textContent = cluster.size;
        document.getElementById('stat-sessions').textContent = cluster.session_count;
        document.getElementById('stat-first').textContent = formatDate(cluster.first_seen);
        document.getElementById('stat-last').textContent = formatDate(cluster.last_seen);

        // Fingerprint
        document.getElementById('fingerprint-value').textContent = cluster.fingerprint;

        // Sample commands (for command clusters)
        if (cluster.metadata && cluster.metadata.sample_commands && cluster.metadata.sample_commands.length > 0) {
            document.getElementById('commands-section').style.display = 'block';
            document.getElementById('commands-list').innerHTML = cluster.metadata.sample_commands
                .map(cmd => `<div class="command-item">$ ${escapeHtml(cmd)}</div>`)
                .join('');

            // Show interest reasons for command clusters
            if (cluster.metadata.interest_reasons) {
                displayInterestReasons(cluster.metadata.interest_reasons);
            }
        }

        // Shared payloads (for command clusters)
        const sharedPayloads = cluster.metadata?.shared_payloads || [];
        if (sharedPayloads.length > 0) {
            document.getElementById('shared-payloads-section').style.display = 'block';
            document.getElementById('shared-payloads-list').innerHTML = sharedPayloads.map(payload => {
                const hashLabel = payload.shasum ? payload.shasum.substring(0, 16) + '...' : 'unknown';
                const vtLabel = payload.vt_detections !== undefined && payload.vt_detections !== null
                    ? ` ‚Ä¢ VT: ${payload.vt_detections}`
                    : '';
                const threatLabel = payload.threat_label ? ` ‚Ä¢ ${escapeHtml(payload.threat_label)}` : '';
                const execLabel = payload.execution_attempts > 0
                    ? ` ‚Ä¢ Exec attempts: ${payload.execution_attempts}`
                    : '';
                const execSamples = payload.execution_samples && payload.execution_samples.length > 0
                    ? `<div style="margin-top: 4px; font-size: 0.85em; color: var(--text-secondary);">Exec samples: ${payload.execution_samples.map(cmd => `<code style="word-break: break-all;">${escapeHtml(cmd)}</code>`).join(', ')}</div>`
                    : '';
                const urlList = payload.sample_urls && payload.sample_urls.length > 0
                    ? `<div style="margin-top: 4px; font-size: 0.85em; color: var(--text-secondary);">URLs: ${payload.sample_urls.map(u => `<code style="word-break: break-all;">${escapeHtml(u)}</code>`).join(', ')}</div>`
                    : '';
                return `<div class="command-item">SHA256 ${hashLabel} ‚Ä¢ ${payload.session_count} sessions ‚Ä¢ ${payload.unique_ips} IPs${vtLabel}${threatLabel}${execLabel}${urlList}${execSamples}</div>`;
            }).join('');
        }

        // Shared HASSH values (for command clusters)
        const sharedHassh = cluster.metadata?.shared_hassh || [];
        if (sharedHassh.length > 0) {
            document.getElementById('hassh-section').style.display = 'block';
            document.getElementById('hassh-list').innerHTML = sharedHassh.map(item => {
                const hasshLabel = item.hassh ? item.hassh.substring(0, 16) + '...' : 'unknown';
                return `<div class="command-item">HASSH ${hasshLabel} ‚Ä¢ ${item.session_count} sessions ‚Ä¢ ${item.unique_ips} IPs</div>`;
            }).join('');
        }

        // Show OpenCTI enrichment section
        document.getElementById('enrichment-section').style.display = 'block';

        // If cluster already has enrichment data, display it
        if (cluster.enrichment) {
            displayEnrichmentData({
                enriched: true,
                opencti_available: true,
                threat_actors: cluster.enrichment.threat_families ?
                    cluster.enrichment.threat_families.map(f => ({name: f})) : [],
                campaigns: [],
                malware_families: cluster.enrichment.threat_families ?
                    cluster.enrichment.threat_families.map(f => ({name: f})) : [],
                tags: cluster.enrichment.tags || [],
            });
        }

        // Members
        const members = cluster.members || [];
        document.getElementById('member-count').textContent = members.length;

        const membersHtml = members.map(member => `
            <div class="member-card" id="member-${member.src_ip.replace(/\./g, '-')}">
                <div>
                    <div class="member-ip">
                        <a href="${basePath}/sessions?ip=${member.src_ip}" style="color: var(--accent-color); text-decoration: none;">
                            ${member.src_ip}
                        </a>
                    </div>
                    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">
                        ${formatDateTime(member.first_seen)} - ${formatDateTime(member.last_seen)}
                    </div>
                </div>
                <div class="member-stats">
                    <div class="member-stat">
                        <div class="member-stat-value">${member.session_count}</div>
                        <div class="member-stat-label">Sessions</div>
                    </div>
                </div>
            </div>
        `).join('');

        document.getElementById('members-list').innerHTML = membersHtml;

        // Load threat intel for first 10 members
        for (const member of members.slice(0, 10)) {
            const intel = await loadThreatIntel(member.src_ip);
            if (intel) {
                const container = document.getElementById('member-' + member.src_ip.replace(/\./g, '-'));
                if (container) {
                    renderThreatIntel(intel, container);
                }
            }
        }

    } catch (error) {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
        document.getElementById('error-message').textContent = error.message;
    }
}

async function enrichCluster() {
    const btn = document.getElementById('enrich-btn');
    btn.disabled = true;
    btn.innerHTML = '<span>‚è≥</span> Enriching...';

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 90000); // 90s client timeout

        const response = await fetch(basePath + '/api/cluster/' + clusterId + '/enrich', {
            method: 'POST',
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || errorData.detail || 'Enrichment failed: ' + response.status);
        }

        const result = await response.json();
        displayEnrichmentData(result);

    } catch (error) {
        let errorMsg = error.message;
        if (error.name === 'AbortError') {
            errorMsg = 'Request timed out - OpenCTI may be slow';
        }
        btn.innerHTML = '<span>‚ùå</span> ' + errorMsg.substring(0, 30);
        btn.disabled = false;
        setTimeout(() => {
            btn.innerHTML = '<span>üîç</span> Retry Enrichment';
        }, 5000);
    }
}

function displayEnrichmentData(enrichment) {
    const contentEl = document.getElementById('enrichment-content');
    const dataEl = document.getElementById('enrichment-data');
    const statusEl = document.getElementById('enrichment-status');

    if (!enrichment.opencti_available) {
        contentEl.innerHTML = '<p style="color: #f39c12;">‚ö†Ô∏è OpenCTI not available: ' +
            (enrichment.errors?.[0] || 'Library not installed') + '</p>';
        return;
    }

    if (enrichment.enriched) {
        statusEl.textContent = 'Enriched';
        statusEl.style.background = '#27ae60';
        contentEl.style.display = 'none';
        dataEl.style.display = 'block';

        // Threat Actors
        if (enrichment.threat_actors && enrichment.threat_actors.length > 0) {
            document.getElementById('threat-actors-card').style.display = 'block';
            document.getElementById('threat-actors-list').innerHTML = enrichment.threat_actors
                .map(actor => `
                    <div class="enrichment-item">
                        <div class="enrichment-item-icon actor">üë§</div>
                        <div>
                            <div class="enrichment-item-name">${escapeHtml(actor.name)}</div>
                            ${actor.description ? `<div style="font-size: 0.8em; color: #888;">${escapeHtml(actor.description.substring(0, 100))}...</div>` : ''}
                        </div>
                    </div>
                `).join('');
        }

        // Campaigns
        if (enrichment.campaigns && enrichment.campaigns.length > 0) {
            document.getElementById('campaigns-card').style.display = 'block';
            document.getElementById('campaigns-list').innerHTML = enrichment.campaigns
                .map(campaign => `
                    <div class="enrichment-item">
                        <div class="enrichment-item-icon campaign">üéØ</div>
                        <div>
                            <div class="enrichment-item-name">${escapeHtml(campaign.name)}</div>
                            ${campaign.description ? `<div style="font-size: 0.8em; color: #888;">${escapeHtml(campaign.description.substring(0, 100))}...</div>` : ''}
                        </div>
                    </div>
                `).join('');
        }

        // Malware Families
        if (enrichment.malware_families && enrichment.malware_families.length > 0) {
            document.getElementById('malware-card').style.display = 'block';
            document.getElementById('malware-list').innerHTML = enrichment.malware_families
                .map(malware => `
                    <div class="enrichment-item">
                        <div class="enrichment-item-icon malware">ü¶†</div>
                        <div>
                            <div class="enrichment-item-name">${escapeHtml(malware.name)}</div>
                            ${malware.description ? `<div style="font-size: 0.8em; color: #888;">${escapeHtml(malware.description.substring(0, 100))}...</div>` : ''}
                        </div>
                    </div>
                `).join('');
        }

        // Tags
        if (enrichment.tags && enrichment.tags.length > 0) {
            const tagsEl = document.getElementById('enrichment-tags');
            tagsEl.style.display = 'flex';
            tagsEl.innerHTML = enrichment.tags
                .map(tag => `<span class="enrichment-tag">${escapeHtml(tag)}</span>`)
                .join('');
        }

    } else {
        statusEl.textContent = 'No Matches';
        statusEl.style.background = '#7f8c8d';
        contentEl.innerHTML = '<p style="color: var(--text-secondary);">No matching threat intelligence found in OpenCTI for this cluster.</p>';
    }
}

function displayInterestReasons(reasons) {
    if (!reasons || reasons.length === 0) return;

    const container = document.getElementById('interest-reasons');
    container.style.display = 'block';
    container.innerHTML = '<div style="margin-top: 10px; font-size: 0.85em; color: var(--text-secondary);">Interest factors: ' +
        reasons.map(r => `<span class="interest-reason">${escapeHtml(r)}</span>`).join('') +
        '</div>';
}

document.addEventListener('DOMContentLoaded', loadData);
</script>
{% endblock %}
