{% extends "base.html" %}

{% block title %}Dashboard - Cowrie Honeypot{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="page-header">
        <h1>Honeypot Dashboard</h1>
        <div class="time-filter">
            <label>Time range:</label>
            <select onchange="window.location.href='?hours=' + this.value">
                <option value="24" {% if hours == 24 %}selected{% endif %}>Last 24 hours</option>
                <option value="48" {% if hours == 48 %}selected{% endif %}>Last 48 hours</option>
                <option value="168" {% if hours == 168 %}selected{% endif %}>Last 7 days</option>
                <option value="720" {% if hours == 720 %}selected{% endif %}>Last 30 days</option>
            </select>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <a href="{{ url_for('sessions', hours=hours) }}" class="stat-card stat-card-link">
            <div class="stat-value">{{ stats.total_sessions }}</div>
            <div class="stat-label">Total Sessions</div>
        </a>
        <a href="{{ url_for('ip_list', hours=hours) }}" class="stat-card stat-card-link">
            <div class="stat-value">{{ stats.unique_ips }}</div>
            <div class="stat-label">Unique IPs</div>
        </a>
        <a href="{{ url_for('sessions', hours=hours, has_commands='1') }}" class="stat-card stat-card-link">
            <div class="stat-value">{{ stats.sessions_with_commands }}</div>
            <div class="stat-label">Sessions with Commands</div>
        </a>
        <a href="{{ url_for('downloads', hours=hours) }}" class="stat-card stat-card-link">
            <div class="stat-value">{{ stats.unique_downloads }} / {{ stats.total_downloads }}</div>
            <div class="stat-label">Unique / Total Downloads</div>
        </a>
    </div>

    <!-- System Information Box -->
    <div class="system-info-box" id="system-info" style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white; display: none;">
        <h3 style="margin: 0 0 10px 0; font-size: 18px;">Honeypot System Information</h3>
        <div class="system-info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <div style="opacity: 0.9; font-size: 12px;">Server IP</div>
                <div style="font-weight: 600; font-size: 16px;" id="server-ip">Loading...</div>
            </div>
            <div>
                <div style="opacity: 0.9; font-size: 12px;">Hostname</div>
                <div style="font-weight: 600; font-size: 16px;" id="honeypot-hostname">Loading...</div>
            </div>
            <div>
                <div style="opacity: 0.9; font-size: 12px;">Cowrie Version</div>
                <div style="font-weight: 600; font-size: 16px;" id="cowrie-version">Loading...</div>
            </div>
            <div>
                <div style="opacity: 0.9; font-size: 12px;">Container Built</div>
                <div style="font-weight: 600; font-size: 16px;" id="build-date">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Canary Tokens Box -->
    <div class="canary-tokens-box" id="canary-tokens" style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white; display: none;">
        <h3 style="margin: 0 0 10px 0; font-size: 18px;">üçØ Canary Tokens Deployed</h3>
        <div id="canary-tokens-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
            <div style="opacity: 0.8; font-size: 14px;">Loading...</div>
        </div>
    </div>

    <div class="dashboard-grid">
        <!-- Attack Map -->
        <div class="dashboard-card full-width">
            <h2>Attack Origins Map</h2>
            <div id="attack-map" style="height: 400px; border-radius: 8px;"></div>
        </div>

        <!-- Top Countries -->
        <div class="dashboard-card">
            <h2>Top Attacking Countries</h2>
            {% if stats.top_countries %}
            <table class="data-table sortable">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Sessions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for country, count in stats.top_countries %}
                    <tr>
                        <td><a href="{{ url_for('sessions', country=country, hours=hours) }}">{{ country }}</a></td>
                        <td>{{ count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No data available</p>
            {% endif %}
        </div>

        <!-- Top Credentials -->
        <div class="dashboard-card">
            <h2>Top Credentials Attempted</h2>
            {% if stats.top_credentials %}
            <table class="data-table sortable">
                <thead>
                    <tr>
                        <th>Username:Password</th>
                        <th>Attempts</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cred, count in stats.top_credentials %}
                    <tr>
                        <td><a href="{{ url_for('sessions', credentials=cred, hours=hours) }}"><code>{{ cred }}</code></a></td>
                        <td>{{ count }}</td>
                        <td>
                            {% if cred in stats.successful_credentials %}
                            <span class="badge badge-success">‚úì Success</span>
                            {% else %}
                            <span class="badge badge-failed">Failed</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No data available</p>
            {% endif %}
        </div>

        <!-- Top SSH Clients -->
        <div class="dashboard-card">
            <h2>Top SSH Clients</h2>
            {% if stats.top_clients %}
            <table class="data-table sortable">
                <thead>
                    <tr>
                        <th>Client Version</th>
                        <th>Sessions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client, count in stats.top_clients %}
                    <tr>
                        <td><code>{{ client }}</code></td>
                        <td>{{ count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No client data available</p>
            {% endif %}
        </div>

        <!-- Top Commands -->
        <div class="dashboard-card full-width">
            <h2>Top Commands Executed</h2>
            {% if stats.top_commands %}
            <table class="data-table sortable">
                <thead>
                    <tr>
                        <th>Count</th>
                        <th>Command</th>
                    </tr>
                </thead>
                <tbody>
                    {% for command, count in stats.top_commands %}
                    <tr>
                        <td>{{ count }}</td>
                        <td><code class="command-text">{{ command }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No commands recorded</p>
            {% endif %}
        </div>

        <!-- Threat Intelligence: GreyNoise -->
        <div class="dashboard-card">
            <h2>üîç GreyNoise Intelligence</h2>
            {% if stats.greynoise_ips %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Classification</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for gn in stats.greynoise_ips[:10] %}
                    <tr>
                        <td><a href="{{ url_for('sessions', ip=gn.ip, hours=hours) }}">{{ gn.ip }}</a></td>
                        <td>
                            {% if gn.classification == 'malicious' %}
                            <span class="badge badge-danger">Malicious</span>
                            {% elif gn.classification == 'benign' %}
                            <span class="badge badge-success">Benign</span>
                            {% else %}
                            <span class="badge badge-warning">Unknown</span>
                            {% endif %}
                        </td>
                        <td>{{ gn.timestamp | format_timestamp }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No GreyNoise data available</p>
            <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 0.5rem;">
                GreyNoise identifies IPs engaged in mass internet scanning.
            </p>
            {% endif %}
        </div>

        <!-- Threat Intelligence: DShield -->
        <div class="dashboard-card">
            <h2>üîç DShield Intelligence</h2>
            {% if stats.dshield_ips %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Last Seen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ds in stats.dshield_ips[:10] %}
                    <tr>
                        <td><a href="{{ url_for('sessions', ip=ds.ip, hours=hours) }}">{{ ds.ip }}</a></td>
                        <td>{{ ds.timestamp | format_timestamp }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No DShield data available</p>
            <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 0.5rem;">
                DShield aggregates firewall logs from thousands of sensors worldwide.
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Activity Chart -->
    {% if stats.hourly_activity %}
    <div class="dashboard-card full-width">
        <h2>Activity Over Time</h2>
        <div class="activity-chart">
            {% set max_activity = stats.hourly_activity | map(attribute=1) | max %}
            {% for hour, count in stats.hourly_activity %}
            <div class="activity-bar"
                 style="height: {{ (count / max_activity * 100) if max_activity > 0 else 0 }}%"
                 title="{{ hour }}: {{ count }} sessions">
            </div>
            {% endfor %}
        </div>
        <div class="chart-labels">
            <span>{{ stats.hourly_activity[0][0] if stats.hourly_activity else '' }}</span>
            <span>{{ stats.hourly_activity[-1][0] if stats.hourly_activity else '' }}</span>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize map
    const map = L.map('attack-map').setView([20, 0], 2);

    // Add tile layer (English labels)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 18,
        language: 'en'
    }).addTo(map);

    // Add markers for attack origins
    const locations = {{ stats.ip_locations | tojson }};
    const markerCounts = {};
    const hours = {{ hours }};

    // Count occurrences of each location
    locations.forEach(loc => {
        const key = `${loc.lat},${loc.lon}`;
        markerCounts[key] = markerCounts[key] || { count: 0, ...loc };
        markerCounts[key].count++;
    });

    // Add markers
    Object.values(markerCounts).forEach(loc => {
        const marker = L.circleMarker([loc.lat, loc.lon], {
            radius: Math.min(5 + Math.log(loc.count) * 3, 20),
            fillColor: '#dc3545',
            color: '#fff',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.6
        }).addTo(map);

        marker.bindPopup(`
            <strong>${loc.city}, ${loc.country}</strong><br>
            IP: <a href="/sessions?ip=${loc.ip}&hours=${hours}" target="_blank">${loc.ip}</a><br>
            Sessions: ${loc.count}
        `);
    });

    // Fetch and display system information
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            // Show the info box
            document.getElementById('system-info').style.display = 'block';

            // Populate fields
            document.getElementById('server-ip').textContent = data.server_ip || 'N/A';
            document.getElementById('honeypot-hostname').textContent = data.honeypot_hostname || 'N/A';
            document.getElementById('cowrie-version').textContent = data.cowrie_version || 'Unknown';

            // Format build date
            if (data.build_date) {
                const buildDate = new Date(data.build_date);
                document.getElementById('build-date').textContent = buildDate.toLocaleString();
            } else {
                document.getElementById('build-date').textContent = 'Unknown';
            }
        })
        .catch(error => {
            console.error('Failed to load system info:', error);
            // Hide the box if fetch fails
            document.getElementById('system-info').style.display = 'none';
        });

    // Fetch and display Canary Token information
    fetch('/api/canary-tokens')
        .then(response => response.json())
        .then(data => {
            if (data.total > 0) {
                // Show the Canary Tokens box
                document.getElementById('canary-tokens').style.display = 'block';

                // Build tokens list HTML
                const tokensHTML = data.tokens.map(token => {
                    const sizeKB = (token.size / 1024).toFixed(1);
                    return `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 6px; flex: 1 1 200px; min-width: 200px;">
                            <div style="font-size: 24px; margin-bottom: 5px;">${token.icon}</div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 3px;">${token.type}</div>
                            <div style="opacity: 0.9; font-size: 12px; margin-bottom: 2px;">${token.description}</div>
                            <div style="opacity: 0.8; font-size: 11px; font-family: monospace;">${token.path}</div>
                            <div style="opacity: 0.7; font-size: 11px; margin-top: 3px;">${sizeKB} KB</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('canary-tokens-list').innerHTML = tokensHTML;
            } else {
                // Hide the box if no tokens
                document.getElementById('canary-tokens').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Failed to load Canary Token info:', error);
            // Hide the box if fetch fails
            document.getElementById('canary-tokens').style.display = 'none';
        });
});
</script>
{% endblock %}
