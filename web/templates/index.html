{% extends "base.html" %}

{% block title %}Dashboard - Cowrie Honeypot{% endblock %}

{% block content %}
{# Build common filter parameters for links #}
{% set filter_params = {'hours': hours} %}
{% if source_filter %}
    {% set _ = filter_params.update({'source': source_filter}) %}
{% endif %}

<div class="dashboard">
    <div class="page-header">
        <h1>Honeypot Dashboard</h1>
        <div class="time-filter">
            {% if available_sources %}
            <label>Source:</label>
            <select id="source-filter" onchange="updateFilters()">
                <option value="" {% if not source_filter %}selected{% endif %}>All Honeypots</option>
                {% for source_name in available_sources %}
                <option value="{{ source_name }}" {% if source_filter == source_name %}selected{% endif %}>{{ source_name }}</option>
                {% endfor %}
            </select>
            {% endif %}
            <label>Time range:</label>
            <select id="time-filter" onchange="updateFilters()">
                <option value="24" {% if hours == 24 %}selected{% endif %}>Last 24 hours</option>
                <option value="48" {% if hours == 48 %}selected{% endif %}>Last 48 hours</option>
                <option value="168" {% if hours == 168 %}selected{% endif %}>Last 7 days</option>
                <option value="720" {% if hours == 720 %}selected{% endif %}>Last 30 days</option>
            </select>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <a href="{{ url_for('sessions', **filter_params) }}" class="stat-card stat-card-link">
            <div class="stat-value">{{ stats.total_sessions }}</div>
            <div class="stat-label">Total Sessions</div>
        </a>
        <a href="{{ url_for('ip_list', **filter_params) }}" class="stat-card stat-card-link">
            <div class="stat-value">{{ stats.unique_ips }}</div>
            <div class="stat-label">Unique IPs</div>
        </a>
        <a href="{{ url_for('sessions', has_commands='1', **filter_params) }}" class="stat-card stat-card-link">
            <div class="stat-value">{{ stats.sessions_with_commands }}</div>
            <div class="stat-label">Sessions with Commands</div>
        </a>
        <a href="{{ url_for('downloads', **filter_params) }}" class="stat-card stat-card-link">
            <div class="stat-value">{{ stats.unique_downloads }} / {{ stats.total_downloads }}</div>
            <div class="stat-label">Unique / Total Downloads</div>
        </a>
    </div>

    <!-- System Information Box -->
    <div id="system-info-container" style="margin: 20px 0; display: none;">
        <!-- Content will be populated by JavaScript -->
    </div>

    <!-- Canary Tokens Box -->
    <div class="canary-tokens-box" id="canary-tokens" style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; color: white; display: none;">
        <h3 style="margin: 0 0 10px 0; font-size: 18px;">üçØ Canary Tokens Deployed</h3>
        <div id="canary-tokens-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
            <div style="opacity: 0.8; font-size: 14px;">Loading...</div>
        </div>
    </div>

    <!-- Recent Canary Alerts Box -->
    {% if recent_webhooks %}
    <div class="canary-alerts-box" style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); border-radius: 8px; color: white;">
        <h3 style="margin: 0 0 10px 0; font-size: 18px;">üê¶ Recent Canary Token Alerts <a href="{{ url_for('canary_alerts') }}" style="font-size: 0.7em; font-weight: normal; float: right; color: white; opacity: 0.9;">View All ‚Üí</a></h3>
        <div style="background: rgba(255,255,255,0.15); border-radius: 6px; padding: 10px;">
            {% for webhook in recent_webhooks %}
            <div style="padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; {% if loop.last %}margin-bottom: 0;{% endif %}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">{{ webhook.token_name }}</div>
                        <div style="font-size: 12px; opacity: 0.9; margin-top: 2px;">
                            <span style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px; margin-right: 5px;">{{ webhook.token_type }}</span>
                            <span>{{ webhook.trigger_ip }}</span>
                            {% if webhook.geo %}
                            <span style="margin-left: 5px;">‚Ä¢ {{ webhook.geo.city }}, {{ webhook.geo.country }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div style="text-align: right; font-size: 11px; opacity: 0.8; white-space: nowrap; margin-left: 10px;">
                        {{ webhook.received_at | format_timestamp }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="dashboard-grid">
        <!-- Attack Map -->
        <div class="dashboard-card full-width">
            <h2>Attack Origins Map</h2>
            <div id="attack-map" style="height: 400px; border-radius: 8px;"></div>
        </div>

        <!-- Top Countries -->
        <div class="dashboard-card">
            <h2>Top Attacking Countries <a href="{{ url_for('countries', **filter_params) }}" style="font-size: 0.7em; font-weight: normal; float: right;">View All ‚Üí</a></h2>
            {% if stats.top_countries %}
            <table class="data-table sortable">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Sessions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in stats.top_countries %}
                    <tr>
                        <td><a href="{{ url_for('sessions', country=item.country, **filter_params) }}">{{ item.country }}</a></td>
                        <td>{{ item.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No data available</p>
            {% endif %}
        </div>

        <!-- Top Credentials -->
        <div class="dashboard-card">
            <h2>Top Credentials Attempted <a href="{{ url_for('credentials', **filter_params) }}" style="font-size: 0.7em; font-weight: normal; float: right;">View All ‚Üí</a></h2>
            {% if stats.top_credentials %}
            <table class="data-table sortable">
                <thead>
                    <tr>
                        <th>Username:Password</th>
                        <th>Attempts</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in stats.top_credentials %}
                    <tr>
                        <td><a href="{{ url_for('sessions', credentials=item.username ~ ':' ~ item.password, **filter_params) }}"><code>{{ item.username }}:{{ item.password }}</code></a></td>
                        <td>{{ item.count }}</td>
                        <td>
                            {% if item.username ~ ':' ~ item.password in stats.successful_credentials %}
                            <span class="badge badge-success">‚úì Success</span>
                            {% else %}
                            <span class="badge badge-failed">Failed</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No data available</p>
            {% endif %}
        </div>

        <!-- Top SSH Clients -->
        <div class="dashboard-card">
            <h2>Top SSH Clients <a href="{{ url_for('clients', **filter_params) }}" style="font-size: 0.7em; font-weight: normal; float: right;">View All ‚Üí</a></h2>
            {% if stats.top_clients %}
            <table class="data-table sortable">
                <thead>
                    <tr>
                        <th>Client Version</th>
                        <th>Sessions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in stats.top_clients %}
                    <tr>
                        <td><a href="{{ url_for('sessions', client_version=item.client, **filter_params) }}"><code>{{ item.client }}</code></a></td>
                        <td>{{ item.count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No client data available</p>
            {% endif %}
        </div>

        <!-- Top Commands -->
        <div class="dashboard-card full-width">
            <h2>Top Commands Executed <a href="{{ url_for('commands', **filter_params) }}" style="font-size: 0.7em; font-weight: normal; float: right;">View All ‚Üí</a></h2>
            {% if stats.top_commands %}
            <table class="data-table sortable">
                <thead>
                    <tr>
                        <th>Count</th>
                        <th>Command</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in stats.top_commands %}
                    <tr>
                        <td><a href="{{ url_for('sessions', command=item.command, **filter_params) }}">{{ item.count }}</a></td>
                        <td><code class="command-text">{{ item.command }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="no-data">No commands recorded</p>
            {% endif %}
        </div>



        <!-- Two-column layout for VirusTotal and ASNs -->
        <div class="dashboard-card full-width" style="margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Threat Intelligence: VirusTotal -->
            <div style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                <h2>üîç VirusTotal Intelligence <a href="{{ url_for('downloads', **filter_params) }}" style="font-size: 0.7em; font-weight: normal; float: right;">View All ‚Üí</a></h2>
                {% if stats.top_downloads_with_vt and stats.top_downloads_with_vt|length > 0 %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>SHA256</th>
                            <th>File Type</th>
                            <th>VT Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dl in stats.top_downloads_with_vt %}
                        <tr>
                            <td>
                                {% set shasum = dl.get('sha256') or dl.get('shasum', '') %}
                                <a href="https://www.virustotal.com/gui/file/{{ shasum }}" target="_blank"
                                   title="{{ shasum }}">
                                    <code>{{ shasum | truncate_hash(16) }}</code>
                                </a>
                            </td>
                            <td>
                                {% set file_category = dl.get('file_category') or 'unknown' %}
                                {% set file_type = dl.get('file_type') or 'unknown' %}
                                {% set category_colors = {
                                    'executable': 'badge-danger',
                                    'script': 'badge-warning',
                                    'archive': 'badge-info',
                                    'document': 'badge-primary',
                                    'data': 'badge-secondary',
                                    'unknown': 'badge-light'
                                } %}
                                <span class="badge {{ category_colors.get(file_category, 'badge-light') }}"
                                      title="{{ file_type }}">
                                    {{ file_category }}
                                </span>
                                <br>
                                <small style="color: var(--text-secondary); font-size: 0.85em;" title="{{ file_type }}">
                                    {{ file_type | truncate(40, True, '...') }}
                                </small>
                            </td>
                            <td>
                                {% set vt_detections = dl.get('vt_detections', 0) %}
                                {% set vt_total = dl.get('vt_total', 0) %}
                                {% if vt_detections >= 40 %}
                                <span class="badge badge-danger">{{ vt_detections }}/{{ vt_total }}</span>
                                {% elif vt_detections >= 10 %}
                                <span class="badge badge-warning">{{ vt_detections }}/{{ vt_total }}</span>
                                {% elif vt_detections > 0 %}
                                <span class="badge badge-info">{{ vt_detections }}/{{ vt_total }}</span>
                                {% elif vt_total > 0 %}
                                <span class="badge badge-success">0/{{ vt_total }}</span>
                                {% elif vt_total == 0 and vt_detections == 0 %}
                                <span class="badge badge-secondary">0/0</span>
                                {% else %}
                                <span class="text-muted">‚Äî</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="no-data">No downloads scanned by VirusTotal</p>
                <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 0.5rem;">
                    Files will appear here once they are scanned by VirusTotal for malware detection.
                </p>
                {% endif %}
            </div>

            <!-- Top Attacking ASNs -->
            <div style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                <h2>üåê Top Attacking ASNs <a href="{{ url_for('asns', **filter_params) }}" style="font-size: 0.7em; font-weight: normal; float: right;">View All ‚Üí</a></h2>
                {% if stats.top_asns %}
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ASN</th>
                            <th>Organization</th>
                            <th>Sessions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in stats.top_asns %}
                        <tr>
                            <td><a href="{{ url_for('ip_list', asn=item.asn, **filter_params) }}"><code>{{ item.asn }}</code></a></td>
                            <td>{{ item.organization }}</td>
                            <td>{{ item.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="no-data">No ASN data available</p>
                <p style="font-size: 0.9em; color: var(--text-secondary); margin-top: 0.5rem;">
                    ASN (Autonomous System Number) identifies the network organization hosting the attacking IP.
                </p>
                {% endif %}
            </div>
            </div>
        </div>
    </div>

    <!-- Activity Chart -->
    {% if stats.hourly_activity %}
    <div class="dashboard-card full-width">
        <h2>Activity Over Time</h2>
        <div class="activity-chart">
            {% set max_activity = stats.hourly_activity | map(attribute=1) | max %}
            {% for hour, count in stats.hourly_activity %}
            <div class="activity-bar"
                 style="height: {{ (count / max_activity * 100) if max_activity > 0 else 0 }}%"
                 title="{{ hour }}: {{ count }} sessions">
            </div>
            {% endfor %}
        </div>
        <div class="chart-labels">
            <span>{{ stats.hourly_activity[0][0] if stats.hourly_activity else '' }}</span>
            <span>{{ stats.hourly_activity[-1][0] if stats.hourly_activity else '' }}</span>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // SECURITY: HTML escape function to prevent XSS attacks
    // All attacker-controlled data MUST be escaped before inserting into HTML
    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
    }

    // Initialize map
    const map = L.map('attack-map').setView([20, 0], 2);

    // Add dark theme tile layer (CartoDB Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap contributors ¬© CARTO',
        maxZoom: 19,
        subdomains: 'abcd'
    }).addTo(map);

    // Add honeypot location markers (green)
    const honeypotLocations = {{ honeypot_locations | tojson }};
    honeypotLocations.forEach(hp => {
        if (hp.lat && hp.lon) {
            const marker = L.marker([hp.lat, hp.lon], {
                icon: L.divIcon({
                    className: 'honeypot-marker',
                    html: '<div style="background:#28a745;width:20px;height:20px;border-radius:50%;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);

            // SECURITY: Escape all user/attacker-controlled data
            marker.bindPopup(`
                <strong style="color:#28a745;">üçØ Honeypot: ${escapeHtml(hp.name)}</strong><br>
                ${hp.city ? escapeHtml(hp.city) + ', ' : ''}${escapeHtml(hp.country) || 'Unknown'}
            `);
        }
    });

    // Add markers for attack origins (red)
    const locations = {{ stats.ip_locations | tojson }};
    const markerCounts = {};
    const hours = {{ hours }};
    const source = {{ source_filter | tojson }};

    // Count occurrences of each location
    locations.forEach(loc => {
        const key = `${loc.lat},${loc.lon}`;
        markerCounts[key] = markerCounts[key] || { count: 0, ...loc };
        markerCounts[key].count++;
    });

    // Add attack origin markers
    Object.values(markerCounts).forEach(loc => {
        const marker = L.circleMarker([loc.lat, loc.lon], {
            radius: Math.min(5 + Math.log(loc.count) * 3, 20),
            fillColor: '#dc3545',
            color: '#fff',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.6
        }).addTo(map);

        // Build URL with source filter if present
        let sessionUrl = `/sessions?ip=${loc.ip}&hours=${hours}`;
        if (source) {
            sessionUrl += `&source=${encodeURIComponent(source)}`;
        }

        // SECURITY: Escape all attacker-controlled data (IPs, cities, countries)
        marker.bindPopup(`
            <strong>${escapeHtml(loc.city)}, ${escapeHtml(loc.country)}</strong><br>
            IP: <a href="${sessionUrl}" target="_blank">${escapeHtml(loc.ip)}</a><br>
            Sessions: ${loc.count}
        `);
    });

    // Fetch and display system information
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('system-info-container');

            // Check if multi-honeypot response
            if (data.honeypots && Array.isArray(data.honeypots)) {
                // Multi-honeypot mode
                let html = '';
                data.honeypots.forEach(hp => {
                    const buildDate = hp.build_date ? new Date(hp.build_date).toLocaleString() : 'Unknown';
                    // SECURITY: Escape all data (even if from API, defense in depth)
                    html += `
                        <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                            <h3 style="margin: 0 0 10px 0; font-size: 18px;">
                                üçØ ${escapeHtml(hp.name)}
                                <a href="{{ url_for('system_info') }}" style="font-size: 0.7em; font-weight: normal; float: right; color: white; opacity: 0.9;">View All Details ‚Üí</a>
                            </h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="opacity: 0.9; font-size: 12px;">Server IP</div>
                                    <div style="font-weight: 600; font-size: 16px;">${escapeHtml(hp.server_ip) || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="opacity: 0.9; font-size: 12px;">Hostname</div>
                                    <div style="font-weight: 600; font-size: 16px;">${escapeHtml(hp.honeypot_hostname) || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="opacity: 0.9; font-size: 12px;">Cowrie Version</div>
                                    <div style="font-weight: 600; font-size: 16px;">${escapeHtml(hp.cowrie_version) || 'Unknown'}</div>
                                </div>
                                <div>
                                    <div style="opacity: 0.9; font-size: 12px;">Container Built</div>
                                    <div style="font-weight: 600; font-size: 16px;">${buildDate}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
                container.style.display = 'block';
            } else {
                // Single honeypot mode
                const buildDate = data.build_date ? new Date(data.build_date).toLocaleString() : 'Unknown';
                container.innerHTML = `
                    <div style="padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                        <h3 style="margin: 0 0 10px 0; font-size: 18px;">
                            Honeypot System Information
                            <a href="{{ url_for('system_info') }}" style="font-size: 0.7em; font-weight: normal; float: right; color: white; opacity: 0.9;">View Details ‚Üí</a>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="opacity: 0.9; font-size: 12px;">Server IP</div>
                                <div style="font-weight: 600; font-size: 16px;">${data.server_ip || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="opacity: 0.9; font-size: 12px;">Hostname</div>
                                <div style="font-weight: 600; font-size: 16px;">${data.honeypot_hostname || 'N/A'}</div>
                            </div>
                            <div>
                                <div style="opacity: 0.9; font-size: 12px;">Cowrie Version</div>
                                <div style="font-weight: 600; font-size: 16px;">${data.cowrie_version || 'Unknown'}</div>
                            </div>
                            <div>
                                <div style="opacity: 0.9; font-size: 12px;">Container Built</div>
                                <div style="font-weight: 600; font-size: 16px;">${buildDate}</div>
                            </div>
                        </div>
                    </div>
                `;
                container.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Failed to load system info:', error);
            // Hide the container if fetch fails
            document.getElementById('system-info-container').style.display = 'none';
        });

    // Fetch and display Canary Token information
    fetch('/api/canary-tokens')
        .then(response => response.json())
        .then(data => {
            if (data.total > 0) {
                // Show the Canary Tokens box
                document.getElementById('canary-tokens').style.display = 'block';

                // Build tokens list HTML
                const tokensHTML = data.tokens.map(token => {
                    const sizeKB = (token.size / 1024).toFixed(1);
                    return `
                        <div style="background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 6px; flex: 1 1 200px; min-width: 200px;">
                            <div style="font-size: 24px; margin-bottom: 5px;">${token.icon}</div>
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 3px;">${token.type}</div>
                            <div style="opacity: 0.9; font-size: 12px; margin-bottom: 2px;">${token.description}</div>
                            <div style="opacity: 0.8; font-size: 11px; font-family: monospace;">${token.path}</div>
                            <div style="opacity: 0.7; font-size: 11px; margin-top: 3px;">${sizeKB} KB</div>
                        </div>
                    `;
                }).join('');

                document.getElementById('canary-tokens-list').innerHTML = tokensHTML;
            } else {
                // Hide the box if no tokens
                document.getElementById('canary-tokens').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Failed to load Canary Token info:', error);
            // Hide the box if fetch fails
            document.getElementById('canary-tokens').style.display = 'none';
        });
});

// Update filters and reload page
function updateFilters() {
    const source = document.getElementById('source-filter') ? document.getElementById('source-filter').value : '';
    const hours = document.getElementById('time-filter').value;

    // Build URL with both parameters
    let url = '?hours=' + hours;
    if (source) {
        url += '&source=' + encodeURIComponent(source);
    }

    window.location.href = url;
}
</script>
{% endblock %}
