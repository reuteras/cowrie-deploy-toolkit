{% extends "base.html" %}

{% block title %}Attack Clusters - Cowrie Honeypot{% endblock %}

{% block content %}
<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
.loading-state { text-align: center; padding: 60px 20px; color: #666; }
.cluster-card { background: var(--bg-secondary); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
.cluster-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.cluster-type { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.75em; font-weight: 600; text-transform: uppercase; }
.cluster-type.command { background: #3498db; color: white; }
.cluster-type.hassh { background: #9b59b6; color: white; }
.cluster-type.payload { background: #e74c3c; color: white; }
.cluster-score { font-size: 1.2em; font-weight: 700; }
.cluster-score.high { color: #e74c3c; }
.cluster-score.medium { color: #f39c12; }
.cluster-score.low { color: #27ae60; }
.cluster-stats { display: flex; gap: 20px; margin: 10px 0; }
.cluster-stat { text-align: center; }
.cluster-stat-value { font-size: 1.5em; font-weight: 600; color: var(--accent-color); }
.cluster-stat-label { font-size: 0.8em; color: var(--text-secondary); }
.cluster-description { color: var(--text-secondary); font-size: 0.9em; margin: 10px 0; }
.cluster-meta { display: flex; gap: 15px; font-size: 0.85em; color: var(--text-tertiary); }
.tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
.tab-btn { padding: 8px 16px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); border-radius: 4px; cursor: pointer; }
.tab-btn.active { background: var(--accent-color); color: white; border-color: var(--accent-color); }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
.stat-card { background: var(--bg-secondary); border-radius: 8px; padding: 20px; text-align: center; }
.stat-card-value { font-size: 2em; font-weight: 700; color: var(--accent-color); }
.stat-card-label { color: var(--text-secondary); margin-top: 5px; }
</style>

<div class="page">
    <div class="page-header">
        <h1>Attack Clusters</h1>
        <div class="header-actions">
            <div class="time-filter">
                <label>Type:</label>
                <select id="type-filter" onchange="reloadPage()">
                    <option value="" {% if not cluster_type %}selected{% endif %}>All Types</option>
                    <option value="command" {% if cluster_type == 'command' %}selected{% endif %}>Command</option>
                    <option value="hassh" id="type-filter-hassh" {% if cluster_type == 'hassh' %}selected{% endif %}>HASSH</option>
                    <option value="payload" {% if cluster_type == 'payload' %}selected{% endif %}>Payload</option>
                </select>
                <label style="margin-left: 10px;">
                    <input type="checkbox" id="show-hassh-filter" onchange="reloadPage()">
                    Show HASSH clusters
                </label>
                <label>Min Size:</label>
                <select id="size-filter" onchange="reloadPage()">
                    <option value="2" {% if min_size == 2 %}selected{% endif %}>2+ IPs</option>
                    <option value="5" {% if min_size == 5 %}selected{% endif %}>5+ IPs</option>
                    <option value="10" {% if min_size == 10 %}selected{% endif %}>10+ IPs</option>
                </select>
                <label>Time range:</label>
                <select id="hours-filter" onchange="reloadPage()">
                    <option value="24" {% if hours == 24 %}selected{% endif %}>Last 24 hours</option>
                    <option value="168" {% if hours == 168 %}selected{% endif %}>Last 7 days</option>
                    <option value="720" {% if hours == 720 %}selected{% endif %}>Last 30 days</option>
                </select>
            </div>
            <button onclick="runAnalysis()" class="btn btn-primary">Run Analysis</button>
            <a href="{{ url_for('index', hours=hours) }}" class="btn">Back to Dashboard</a>
        </div>
    </div>

    <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p style="font-size: 16px; font-weight: 500;">Loading clusters...</p>
    </div>

    <div id="error-state" class="loading-state" style="display:none; color: #d32f2f;">
        <p style="font-size: 16px; font-weight: 500;">Failed to load clusters</p>
        <p style="font-size: 12px;" id="error-message"></p>
        <button onclick="loadData()" style="margin-top: 15px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
    </div>

    <div id="content" style="display: none;">
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-card-value" id="total-clusters">0</div>
                <div class="stat-card-label">Total Clusters</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value" id="command-clusters">0</div>
                <div class="stat-card-label">Command Clusters</div>
            </div>
            <div class="stat-card" id="hassh-stat-card">
                <div class="stat-card-value" id="hassh-clusters">0</div>
                <div class="stat-card-label">HASSH Clusters</div>
            </div>
            <div class="stat-card">
                <div class="stat-card-value" id="payload-clusters">0</div>
                <div class="stat-card-label">Payload Clusters</div>
            </div>
        </div>

        <div class="info-box" style="margin: 20px 0;">
            <p>Clusters group related attack sessions by shared characteristics.
            <strong>Command clusters</strong> share the same command sequence fingerprint.
            <strong>Payload clusters</strong> downloaded the same malware.
            <strong>HASSH clusters</strong> are optional and only built when explicitly requested.</p>
        </div>

        <div id="clusters-list"></div>

        <div id="no-clusters" style="display: none; text-align: center; padding: 40px; color: var(--text-secondary);">
            <p style="font-size: 1.2em;">No clusters found matching the criteria</p>
            <p style="font-size: 0.9em;">Try adjusting filters or running cluster analysis</p>
            <button onclick="runDiagnose()" class="btn" style="margin-top: 15px;">Run Diagnostics</button>
        </div>

        <div id="diagnose-results" style="display: none; margin-top: 20px;">
            <div class="section-title">Diagnostic Results</div>
            <pre id="diagnose-output" style="background: var(--bg-tertiary); padding: 15px; border-radius: 6px; overflow-x: auto; font-size: 0.85em;"></pre>
        </div>
    </div>
</div>

<script>
function reloadPage() {
    const type = document.getElementById('type-filter').value;
    const size = document.getElementById('size-filter').value;
    const hours = document.getElementById('hours-filter').value;
    const showHassh = document.getElementById('show-hassh-filter').checked ? '1' : '';
    let url = '?hours=' + hours + '&min_size=' + size;
    if (type) url += '&type=' + type;
    if (showHassh) url += '&show_hassh=1';
    window.location.href = url;
}

function getScoreClass(score) {
    if (score >= 70) return 'high';
    if (score >= 40) return 'medium';
    return 'low';
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    const date = new Date(dateStr);
    // ISO format: YYYY-MM-DD HH:MM:SS
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

function getVTBadge(metadata) {
    if (!metadata) return '';
    const vtDetections = metadata.vt_detections;
    const threatLabel = metadata.threat_label;
    if (vtDetections === undefined && !threatLabel) return '';

    let badge = '';
    if (vtDetections !== undefined) {
        const color = vtDetections > 10 ? '#e74c3c' : vtDetections > 0 ? '#f39c12' : '#27ae60';
        badge += `<span style="background: ${color}; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-right: 5px;">VT: ${vtDetections}/70</span>`;
    }
    if (threatLabel) {
        badge += `<span style="background: #9b59b6; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em;">${threatLabel}</span>`;
    }
    return badge;
}

function renderCommandSignals(metadata) {
    if (!metadata) return '';
    const payloadCount = metadata.shared_payloads_count || 0;
    const hasshCount = metadata.shared_hassh_count || 0;
    const execCount = metadata.shared_payloads_execution_count || 0;
    const signals = [];
    if (payloadCount > 0) {
        signals.push(`${payloadCount} shared payload${payloadCount > 1 ? 's' : ''}`);
    }
    if (execCount > 0) {
        signals.push(`${execCount} payload exec attempt${execCount > 1 ? 's' : ''}`);
    }
    if (hasshCount > 0) {
        signals.push(`${hasshCount} shared HASSH`);
    }
    if (signals.length === 0) return '';
    return `<div style="margin-top: 6px; font-size: 0.85em; color: var(--text-secondary);"><strong>Also observed:</strong> ${signals.join(', ')}</div>`;
}

function renderClusterBadges(cluster) {
    const metadata = cluster.metadata || {};
    const badges = [];

    if (cluster.cluster_type === 'command') {
        const payloadCount = metadata.shared_payloads_count || 0;
        const hasshCount = metadata.shared_hassh_count || 0;
        const execCount = metadata.shared_payloads_execution_count || 0;
        if (payloadCount > 0) {
            badges.push(`<span style="background: #2c3e50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 6px;">Payloads: ${payloadCount}</span>`);
        }
        if (execCount > 0) {
            badges.push(`<span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 6px;">Exec: ${execCount}</span>`);
        }
        if (hasshCount > 0) {
            badges.push(`<span style="background: #8e44ad; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 6px;">HASSH: ${hasshCount}</span>`);
        }
    }

    if (cluster.cluster_type === 'payload') {
        const urlCount = (metadata.sample_urls || []).length;
        const execAttempts = metadata.exec_attempts || 0;
        if (urlCount > 0) {
            badges.push(`<span style="background: #16a085; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 6px;">URLs: ${urlCount}</span>`);
        }
        if (execAttempts > 0) {
            badges.push(`<span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 6px;">Exec: ${execAttempts}</span>`);
        }
    }

    if (cluster.cluster_type === 'hassh') {
        const hasshShort = cluster.fingerprint ? cluster.fingerprint.substring(0, 12) : '';
        if (hasshShort) {
            badges.push(`<span style="background: #34495e; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75em; margin-left: 6px;">HASSH: ${hasshShort}</span>`);
        }
    }

    return badges.join('');
}

function loadData() {
    const urlParams = new URLSearchParams(window.location.search);
    const hours = urlParams.get('hours') || '168';
    const minSize = urlParams.get('min_size') || '2';
    let clusterType = urlParams.get('type') || '';
    const showHassh = urlParams.get('show_hassh') === '1';
    const hasshToggle = document.getElementById('show-hassh-filter');
    if (hasshToggle) hasshToggle.checked = showHassh;
    const hasshOption = document.getElementById('type-filter-hassh');
    if (hasshOption) hasshOption.style.display = showHassh ? 'inline' : 'none';
    const hasshStatCard = document.getElementById('hassh-stat-card');
    if (hasshStatCard) hasshStatCard.style.display = showHassh ? 'block' : 'none';
    if (!showHassh && clusterType === 'hassh') {
        clusterType = '';
        document.getElementById('type-filter').value = '';
    }

    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('error-state').style.display = 'none';
    document.getElementById('content').style.display = 'none';

    // Convert hours to days for API
    const days = Math.max(1, Math.floor(parseInt(hours) / 24));

    let apiUrl = basePath + '/api/clusters-data?days=' + days + '&min_size=' + minSize;
    if (clusterType) apiUrl += '&cluster_type=' + clusterType;

    fetch(apiUrl)
        .then(response => {
            if (!response.ok) throw new Error('Server returned ' + response.status);
            return response.json();
        })
        .then(data => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('content').style.display = 'block';

            let clusters = data.clusters || [];
            if (!showHassh) {
                clusters = clusters.filter(c => c.cluster_type !== 'hassh');
            }

            // Update stats
            document.getElementById('total-clusters').textContent = clusters.length;
            document.getElementById('command-clusters').textContent = clusters.filter(c => c.cluster_type === 'command').length;
            document.getElementById('hassh-clusters').textContent = clusters.filter(c => c.cluster_type === 'hassh').length;
            document.getElementById('payload-clusters').textContent = clusters.filter(c => c.cluster_type === 'payload').length;

            const listEl = document.getElementById('clusters-list');
            const noDataEl = document.getElementById('no-clusters');

            if (clusters.length === 0) {
                listEl.innerHTML = '';
                noDataEl.style.display = 'block';
                return;
            }

            noDataEl.style.display = 'none';
            listEl.innerHTML = clusters.map(cluster => {
                const vtBadge = cluster.cluster_type === 'payload' ? getVTBadge(cluster.metadata) : '';
                const sampleUrls = cluster.metadata?.sample_urls || [];
                const urlsHtml = cluster.cluster_type === 'payload' && sampleUrls.length > 0
                    ? `<div style="margin-top: 8px; font-size: 0.85em; color: var(--text-secondary);"><strong>Sample URLs:</strong> ${sampleUrls.slice(0, 2).map(u => `<code style="word-break: break-all;">${u}</code>`).join(', ')}${sampleUrls.length > 2 ? ` (+${sampleUrls.length - 2} more)` : ''}</div>`
                    : '';
                const commandSignals = cluster.cluster_type === 'command' ? renderCommandSignals(cluster.metadata) : '';
                const clusterBadges = renderClusterBadges(cluster);

                return `
                <div class="cluster-card">
                    <div class="cluster-header">
                        <div>
                            <span class="cluster-type ${cluster.cluster_type}">${cluster.cluster_type}</span>
                            <strong style="margin-left: 10px;">${cluster.name || cluster.cluster_id}</strong>
                            ${vtBadge ? `<span style="margin-left: 10px;">${vtBadge}</span>` : ''}
                            ${clusterBadges}
                        </div>
                        <div class="cluster-score ${getScoreClass(cluster.score)}">
                            Score: ${cluster.score}
                        </div>
                    </div>
                    <div class="cluster-stats">
                        <div class="cluster-stat">
                            <div class="cluster-stat-value">${cluster.size}</div>
                            <div class="cluster-stat-label">Unique IPs</div>
                        </div>
                        <div class="cluster-stat">
                            <div class="cluster-stat-value">${cluster.session_count}</div>
                            <div class="cluster-stat-label">Sessions</div>
                        </div>
                        ${cluster.cluster_type === 'payload' && cluster.metadata?.vt_detections !== undefined ? `
                        <div class="cluster-stat">
                            <div class="cluster-stat-value" style="color: ${cluster.metadata.vt_detections > 10 ? '#e74c3c' : cluster.metadata.vt_detections > 0 ? '#f39c12' : '#27ae60'};">${cluster.metadata.vt_detections}</div>
                            <div class="cluster-stat-label">VT Detections</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="cluster-description">${cluster.description || ''}</div>
                    ${commandSignals}
                    ${urlsHtml}
                    <div class="cluster-meta">
                        <span>First seen: ${formatDate(cluster.first_seen)}</span>
                        <span>Last seen: ${formatDate(cluster.last_seen)}</span>
                        <span>Fingerprint: <code>${cluster.fingerprint ? cluster.fingerprint.substring(0, 16) : '-'}...</code></span>
                    </div>
                    <div style="margin-top: 10px;">
                        <a href="${basePath}/cluster/${cluster.cluster_id}" class="btn btn-sm">View Details</a>
                    </div>
                </div>
            `}).join('');
        })
        .catch(error => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = error.message;
        });
}

function runAnalysis() {
    const urlParams = new URLSearchParams(window.location.search);
    const hours = urlParams.get('hours') || '168';
    const minSize = urlParams.get('min_size') || '2';
    const showHassh = urlParams.get('show_hassh') === '1';
    const days = Math.max(1, Math.floor(parseInt(hours) / 24));

    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('content').style.display = 'none';
    document.getElementById('loading-state').querySelector('p').textContent = 'Running cluster analysis...';

    let analyzeUrl = basePath + '/api/clusters-analyze?days=' + days + '&min_size=' + minSize;
    if (showHassh) {
        analyzeUrl += '&cluster_types=command,payload,ttp,hassh';
    }
    fetch(analyzeUrl, {
        method: 'POST'
    })
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading-state').querySelector('p').textContent = 'Loading clusters...';
            loadData();
        })
        .catch(error => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = 'Analysis failed: ' + error.message;
        });
}

function runDiagnose() {
    const urlParams = new URLSearchParams(window.location.search);
    const hours = urlParams.get('hours') || '168';
    const days = Math.max(1, Math.floor(parseInt(hours) / 24));

    document.getElementById('diagnose-results').style.display = 'block';
    document.getElementById('diagnose-output').textContent = 'Running diagnostics...';

    fetch(basePath + '/api/clusters-diagnose?days=' + days)
        .then(response => {
            if (!response.ok) {
                throw new Error('Server returned ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            // Check for error response
            if (data.error) {
                document.getElementById('diagnose-output').textContent = 'Error: ' + data.error + '\n\nMake sure the API container is running and the clustering service is properly configured.';
                return;
            }

            let output = '=== DATABASE CONFIGURATION ===\n';
            output += 'Source DB (Cowrie data): ' + (data.db_path || 'not configured') + '\n';
            output += 'Clustering DB (results): ' + (data.clustering_db_path || 'not configured') + '\n';
            output += 'Cutoff time: ' + (data.cutoff || 'unknown') + '\n\n';

            output += '=== DATA COUNTS ===\n';
            if (data.data_counts && Object.keys(data.data_counts).length > 0) {
                for (const [key, value] of Object.entries(data.data_counts)) {
                    output += `  ${key}: ${value}\n`;
                }
            } else {
                output += '  No data found\n';
            }

            output += '\n=== SAMPLE TIMESTAMPS ===\n';
            if (data.sample_timestamps && Object.keys(data.sample_timestamps).length > 0) {
                for (const [key, value] of Object.entries(data.sample_timestamps)) {
                    output += `  ${key}: ${value}\n`;
                }
            } else {
                output += '  No timestamps found\n';
            }

            output += '\n=== SOURCE DATABASE TABLES ===\n';
            if (data.tables && data.tables.existing && data.tables.existing.length > 0) {
                output += '  ' + data.tables.existing.join(', ') + '\n';
            } else {
                output += '  No tables found\n';
            }

            output += '\n=== CLUSTERING DATABASE TABLES ===\n';
            if (data.clustering_tables && data.clustering_tables.existing && data.clustering_tables.existing.length > 0) {
                output += '  ' + data.clustering_tables.existing.join(', ') + '\n';
            } else {
                output += '  No tables found (will be created on first analysis run)\n';
            }

            if (data.issues && data.issues.length > 0) {
                output += '\n=== ISSUES DETECTED ===\n';
                for (const issue of data.issues) {
                    output += `  - ${issue}\n`;
                }
            } else {
                output += '\n=== NO ISSUES DETECTED ===\n';
            }

            document.getElementById('diagnose-output').textContent = output;
        })
        .catch(error => {
            document.getElementById('diagnose-output').textContent = 'Error: ' + error.message + '\n\nThis might indicate the API is not available or there is a network issue.';
        });
}

document.addEventListener('DOMContentLoaded', loadData);
</script>
{% endblock %}
