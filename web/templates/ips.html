{% extends "base.html" %}

{% block title %}IP Addresses - Cowrie Honeypot{% endblock %}

{% block content %}
<div class="ips-page">
    <div class="page-header">
        <h1>Attacking IP Addresses</h1>
        <div class="time-filter">
            <label>Time range:</label>
            <select onchange="window.location.href='?hours=' + this.value">
                <option value="24" {% if hours == 24 %}selected{% endif %}>Last 24 hours</option>
                <option value="48" {% if hours == 48 %}selected{% endif %}>Last 48 hours</option>
                <option value="168" {% if hours == 168 %}selected{% endif %}>Last 7 days</option>
                <option value="720" {% if hours == 720 %}selected{% endif %}>Last 30 days</option>
            </select>
        </div>
    </div>

    <!-- Filters -->
    {% if asn_filter or country_filter or city_filter %}
    <div class="filter-badges" style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
        <span style="font-weight: 600; color: var(--text-primary);">Active Filters:</span>
        {% if country_filter %}
        <span class="badge badge-info" style="display: inline-flex; align-items: center; gap: 5px;">
            Country: {{ country_filter }}
            <a href="{{ url_for('ip_list', hours=hours, asn=asn_filter, city=city_filter) }}" style="color: inherit; text-decoration: none; margin-left: 3px;">✕</a>
        </span>
        {% endif %}
        {% if city_filter %}
        <span class="badge badge-info" style="display: inline-flex; align-items: center; gap: 5px;">
            City: {{ city_filter }}
            <a href="{{ url_for('ip_list', hours=hours, asn=asn_filter, country=country_filter) }}" style="color: inherit; text-decoration: none; margin-left: 3px;">✕</a>
        </span>
        {% endif %}
        {% if asn_filter %}
        <span class="badge badge-info" style="display: inline-flex; align-items: center; gap: 5px;">
            ASN: {{ asn_filter }}
            <a href="{{ url_for('ip_list', hours=hours, country=country_filter, city=city_filter) }}" style="color: inherit; text-decoration: none; margin-left: 3px;">✕</a>
        </span>
        {% endif %}
        <a href="{{ url_for('ip_list', hours=hours) }}" class="badge" style="background: var(--danger); color: white; text-decoration: none;">Clear All Filters</a>
    </div>
    {% endif %}

    <div class="ips-info">
        <p>{{ ips | length }} unique IP addresses</p>
    </div>

    <table class="data-table ips-table sortable">
        <thead>
            <tr>
                <th>IP Address</th>
                <th>Country</th>
                <th>City</th>
                <th>ASN</th>
                <th>Organization</th>
                <th>Sessions</th>
                <th>Successful Logins</th>
                <th>Failed Logins</th>
                <th>Last Seen</th>
            </tr>
        </thead>
        <tbody>
            {% for ip_data in ips %}
            <tr>
                <td>
                    <a href="{{ url_for('sessions', ip=ip_data.ip, hours=hours) }}" class="ip-link">
                        <code>{{ ip_data.ip }}</code>
                    </a>
                </td>
                <td>
                    {% if ip_data.geo and ip_data.geo.country %}
                    <a href="{{ url_for('ip_list', country=ip_data.geo.country, city=city_filter, asn=asn_filter, hours=hours) }}" title="Filter by country">{{ ip_data.geo.country }}</a>
                    {% else %}
                    Unknown
                    {% endif %}
                </td>
                <td>
                    {% if ip_data.geo and ip_data.geo.city %}
                    <a href="{{ url_for('ip_list', city=ip_data.geo.city, country=country_filter or ip_data.geo.country, asn=asn_filter, hours=hours) }}" title="Filter by city">{{ ip_data.geo.city }}</a>
                    {% else %}
                    Unknown
                    {% endif %}
                </td>
                <td>
                    {% if ip_data.geo and ip_data.geo.asn %}
                    <a href="{{ url_for('ip_list', asn='AS' + ip_data.geo.asn|string, country=country_filter, city=city_filter, hours=hours) }}" title="Filter by ASN"><code>AS{{ ip_data.geo.asn }}</code></a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if ip_data.geo and ip_data.geo.asn_org %}
                    {{ ip_data.geo.asn_org }}
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('sessions', ip=ip_data.ip, hours=hours) }}" class="badge badge-success">
                        {{ ip_data.count }}
                    </a>
                </td>
                <td>
                    {% if ip_data.successful_logins > 0 %}
                    <span class="badge badge-danger" title="Successful breaches">{{ ip_data.successful_logins }}</span>
                    {% else %}
                    <span class="text-muted">0</span>
                    {% endif %}
                </td>
                <td>
                    {% if ip_data.failed_logins > 0 %}
                    <span class="badge badge-warning">{{ ip_data.failed_logins }}</span>
                    {% else %}
                    <span class="text-muted">0</span>
                    {% endif %}
                </td>
                <td>{{ ip_data.last_seen | format_timestamp if ip_data.last_seen else 'N/A' }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="no-data">No IP addresses recorded</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
