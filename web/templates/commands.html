{% extends "base.html" %}

{% block title %}Commands - Cowrie Honeypot{% endblock %}

{% block content %}
<style>
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
.loading-state { text-align: center; padding: 60px 20px; color: #666; }
</style>

<div class="commands-page">
    <div class="page-header">
        <h1>Commands Executed</h1>
        <div class="filters">
            <div class="filter-form">
                {% if available_sources %}
                <select id="source-filter" onchange="reloadPage()">
                    <option value="" {% if not source_filter %}selected{% endif %}>All Honeypots</option>
                    {% for source_name in available_sources %}
                    <option value="{{ source_name }}" {% if source_filter == source_name %}selected{% endif %}>{{ source_name }}</option>
                    {% endfor %}
                </select>
                {% endif %}
                <select id="hours-filter" onchange="reloadPage()">
                    <option value="24" {% if hours == 24 %}selected{% endif %}>Last 24 hours</option>
                    <option value="48" {% if hours == 48 %}selected{% endif %}>Last 48 hours</option>
                    <option value="168" {% if hours == 168 %}selected{% endif %}>Last 7 days</option>
                    <option value="720" {% if hours == 720 %}selected{% endif %}>Last 30 days</option>
                </select>
                <label>
                    <input type="checkbox" id="unique-filter" value="1"
                           {% if unique == '1' %}checked{% endif %}
                           onchange="reloadPage()">
                    Unique commands
                </label>
                <button type="button" onclick="reloadPage()">Filter</button>
            </div>
        </div>
    </div>

    <div id="loading-state" class="loading-state">
        <div class="spinner"></div>
        <p style="font-size: 16px; font-weight: 500;">Loading commands...</p>
        <p style="font-size: 12px;">This may take a few seconds</p>
    </div>

    <div id="error-state" class="loading-state" style="display:none; color: #d32f2f;">
        <p style="font-size: 16px; font-weight: 500;">⚠️ Failed to load commands</p>
        <p style="font-size: 12px;" id="error-message"></p>
        <button onclick="loadCommands()" style="margin-top: 15px; padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">Retry</button>
    </div>

    <table id="data-table" class="data-table commands-table sortable" style="display:none;">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Command</th>
                <th>Source IP</th>
                <th>Session</th>
            </tr>
        </thead>
        <tbody id="table-body"></tbody>
    </table>
</div>

<script>
function reloadPage() {
    const source = document.getElementById('source-filter') ? document.getElementById('source-filter').value : '';
    const hours = document.getElementById('hours-filter').value;
    const unique = document.getElementById('unique-filter').checked ? '1' : '';

    let url = '?hours=' + hours;
    if (source) url += '&source=' + encodeURIComponent(source);
    if (unique) url += '&unique=' + unique;

    window.location.href = url;
}

function formatTimestamp(ts) {
    if (!ts) return 'N/A';
    try {
        const date = new Date(ts);
        return date.toLocaleString();
    } catch (e) {
        return ts;
    }
}

function truncateHash(hash) {
    if (!hash) return 'N/A';
    if (hash.length <= 12) return hash;
    return hash.substring(0, 12) + '...';
}

function loadCommands() {
    const urlParams = new URLSearchParams(window.location.search);
    const hours = urlParams.get('hours') || '{{ hours }}';
    const source = urlParams.get('source') || '{{ source_filter }}';
    const unique = urlParams.get('unique') || '{{ unique }}';

    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('error-state').style.display = 'none';
    document.getElementById('data-table').style.display = 'none';

    let apiUrl = '/api/commands-data?hours=' + hours;
    if (source) apiUrl += '&source=' + encodeURIComponent(source);
    if (unique) apiUrl += '&unique=' + unique;

    fetch(apiUrl)
        .then(response => {
            if (!response.ok) throw new Error('Server returned ' + response.status);
            return response.json();
        })
        .then(data => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('data-table').style.display = 'table';

            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (!data.commands || data.commands.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No commands recorded in this period.</td></tr>';
                return;
            }

            data.commands.forEach(cmd => {
                const row = document.createElement('tr');

                const timestamp = formatTimestamp(cmd.timestamp);
                const command = '<code>' + cmd.command + '</code>';
                const ipLink = '<a href="/sessions?ip=' + encodeURIComponent(cmd.src_ip) + '&hours=' + hours + '" class="ip-link"><code>' + cmd.src_ip + '</code></a>';
                const sessionLink = '<a href="/session/' + cmd.session_id + '" class="session-link">' + truncateHash(cmd.session_id) + '</a>';

                row.innerHTML =
                    '<td>' + timestamp + '</td>' +
                    '<td>' + command + '</td>' +
                    '<td>' + ipLink + '</td>' +
                    '<td>' + sessionLink + '</td>';

                tbody.appendChild(row);
            });
        })
        .catch(error => {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = error.message;
        });
}

document.addEventListener('DOMContentLoaded', loadCommands);
</script>
{% endblock %}
