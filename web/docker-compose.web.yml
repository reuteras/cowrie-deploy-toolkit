# Docker Compose configuration for Cowrie with Web Dashboard
# This file is used when web_dashboard is enabled in master-config.toml
#
# Features:
# - Cowrie SSH honeypot on port 22
# - Web dashboard for session playback (internal network only)
# - Optional Tailscale sidecar for secure remote access
#
# The web dashboard is NOT exposed to the public internet.
# Access is via Tailscale or SSH tunnel only.

services:
  cowrie:
    image: cowrie/cowrie:latest
    container_name: cowrie
    restart: unless-stopped
    ports:
      - "22:2222"
    volumes:
      - cowrie-etc:/cowrie/cowrie-git/etc
      - cowrie-var:/cowrie/cowrie-git/var
      - /opt/cowrie/share:/cowrie/cowrie-git/share:ro
    environment:
      - COWRIE_HOSTNAME=server
    # Security hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    networks:
      - cowrie-internal

  # SSH Session Playback Web Service
  # Accessible only via Tailscale or SSH tunnel
  cowrie-web:
    build:
      context: /opt/cowrie/web
      dockerfile: Dockerfile
    image: cowrie-web:local
    container_name: cowrie-web
    restart: unless-stopped
    # NOT exposed to public - only on internal network
    # Access via Tailscale or SSH tunnel (ssh -L 5000:localhost:5000)
    expose:
      - "5000"
    ports:
      # Only listen on localhost for SSH tunnel access
      - "127.0.0.1:5000:5000"
    volumes:
      # Mount Cowrie data read-only
      - cowrie-var:/cowrie-data:ro
      # Mount GeoIP database if available
      - /var/lib/GeoIP:/geoip:ro
      # Mount YARA/VT cache directory (from yara-scanner-daemon on host)
      - /opt/cowrie/var:/yara-cache:ro
    environment:
      - COWRIE_LOG_PATH=/cowrie-data/log/cowrie/cowrie.json
      - COWRIE_TTY_PATH=/cowrie-data/lib/cowrie/tty
      - COWRIE_DOWNLOAD_PATH=/cowrie-data/lib/cowrie/downloads
      - GEOIP_DB_PATH=/geoip/GeoLite2-City.mmdb
      - YARA_CACHE_DB_PATH=/yara-cache/yara-cache.db
      - BASE_URL=${WEB_BASE_URL:-}
    depends_on:
      - cowrie
    networks:
      - cowrie-internal
    # Security hardening
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:size=10M,mode=1777

volumes:
  cowrie-etc:
    name: cowrie-etc
  cowrie-var:
    name: cowrie-var

networks:
  cowrie-internal:
    driver: bridge
