---
services:
  cowrie-api:
    image: ghcr.io/reuteras/cowrie-api:latest
    container_name: cowrie-api
    restart: unless-stopped
    networks:
      - cowrie-internal
    volumes:
      # Read-only access to Cowrie data
      - cowrie-var:/cowrie/cowrie-git/var:ro
      - cowrie-etc:/cowrie-etc:ro
      # Writable cache for API processing
      - cowrie-cache:/cowrie-cache
      - /opt/cowrie/var:/opt-cowrie-data:ro
      - /opt/cowrie/metadata.json:/cowrie-metadata/metadata.json:ro
      - /opt/cowrie/identity:/identity:ro
      - /var/lib/GeoIP:/geoip:ro
    environment:
       - COWRIE_LOG_PATH=/cowrie/cowrie-git/var/log/cowrie/cowrie.json
       - COWRIE_DB_PATH=/cowrie/cowrie-git/var/lib/cowrie/cowrie.db
       - CLUSTERING_DB_PATH=/cowrie-cache/clustering.db
       - COWRIE_TTY_PATH=/cowrie/cowrie-git/var/lib/cowrie/tty
       - COWRIE_DOWNLOADS_PATH=/cowrie/cowrie-git/var/lib/cowrie/downloads
       - COWRIE_SHARE_PATH=/cowrie/cowrie-git/var/share/cowrie
       - COWRIE_METADATA_PATH=/cowrie-metadata/metadata.json
       - IDENTITY_PATH=/identity
       - SERVER_IP=SERVER_IP_PLACEHOLDER
       - HONEYPOT_HOSTNAME=HONEYPOT_HOSTNAME_PLACEHOLDER
       - GEOIP_CITY_DB=/geoip/GeoLite2-City.mmdb
       - GEOIP_ASN_DB=/geoip/GeoLite2-ASN.mmdb
       - YARA_CACHE_DB=/cowrie/cowrie-git/var/cache/yara-cache.db
       - VT_CACHE_DB=/cowrie/cowrie-git/var/cache/vt-cache.db
       - CANARY_WEBHOOKS_DB=/opt-cowrie-data/canary-webhooks.db
       - IPLOCK_DB=/cowrie-data/lib/cowrie/iplock.db
       - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY:-}
       - ABUSEIPDB_API_KEY=${ABUSEIPDB_API_KEY:-}
       - LOG_LEVEL=${API_LOG_LEVEL:-INFO}
    # Security hardening
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100M
      - /app/.cache:noexec,nosuid,size=50M

    # Expose on localhost for Tailscale Serve access
    # Safe to keep enabled - only accessible from localhost (127.0.0.1)
    ports:
      - "127.0.0.1:8000:8000"

networks:
  cowrie-internal:
    name: cowrie-internal

volumes:
  cowrie-var:
    name: cowrie-var
  cowrie-etc:
    name: cowrie-etc
  cowrie-cache:
    name: cowrie-cache
