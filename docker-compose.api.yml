---
services:
  cowrie-api:
    image: ghcr.io/reuteras/cowrie-api:latest
    container_name: cowrie-api
    restart: unless-stopped
    networks:
      - cowrie-internal
    volumes:
      # Writable cache for API processing only
      - cowrie-cache:/cowrie-cache
      - cowrie-var:/remote-cowrie-data
      # Mount local code for testing fixes
      - ./api:/app
      # Metadata from Cowrie container
      - /opt/cowrie/metadata.json:/cowrie-metadata/metadata.json:ro
      # GeoIP databases for country/ASN enrichment
      - /var/lib/GeoIP:/geoip:ro
    environment:
      # Remote database configuration
      - COWRIE_DB_PATH=/remote-cowrie-data/lib/cowrie/cowrie.db
      - COWRIE_LOG_PATH=/remote-cowrie-data/log/cowrie/cowrie.log
      - CLUSTERING_DB_PATH=/cowrie-cache/clustering.db
      - LOG_LEVEL=${API_LOG_LEVEL:-INFO}
      # System info (replaced by deploy script)
      - SERVER_IP=SERVER_IP_PLACEHOLDER
      - HONEYPOT_HOSTNAME=HONEYPOT_HOSTNAME_PLACEHOLDER
      - COWRIE_METADATA_PATH=/cowrie-metadata/metadata.json
      # Optional OpenCTI integration
      - OPENCTI_URL=${OPENCTI_URL:-}
      - OPENCTI_API_KEY=${OPENCTI_API_KEY:-}
      - OPENCTI_SSL_VERIFY=${OPENCTI_SSL_VERIFY:-true}
      - OPENCTI_AUTO_PUSH=${OPENCTI_AUTO_PUSH:-false}
      - OPENCTI_PUSH_THRESHOLD=${OPENCTI_PUSH_THRESHOLD:-70}
      # Optional threat intelligence
      - VIRUSTOTAL_API_KEY=${VIRUSTOTAL_API_KEY:-}
      - ABUSEIPDB_API_KEY=${ABUSEIPDB_API_KEY:-}
    # Security hardening
    user: "1000:1000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100M
      - /app/.cache:noexec,nosuid,size=50M

    # Expose on localhost for Tailscale Serve access
    # Safe to keep enabled - only accessible from localhost (127.0.0.1)
    ports:
      - "127.0.0.1:8000:8000"

networks:
  cowrie-internal:
    name: cowrie-internal

volumes:
  cowrie-var:
    name: cowrie-var
  cowrie-etc:
    name: cowrie-etc
  cowrie-cache:
    name: cowrie-cache
